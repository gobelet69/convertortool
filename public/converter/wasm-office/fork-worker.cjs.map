{"version":3,"sources":["../src/fork-worker.cts"],"names":["path","fs"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,IAAA,mBAAA,GAAA,UAAA,CAAA;AAAA,EAAA,qBAAA,GAAA;AAOA,IAAA,IAAM,QAAA,GAAW,OAAA,CAAQ,GAAA,CAAI,SAAA,IAAa,QAAA;AAC1C,IAAA,IAAM,OAAA,GAAU,OAAA,CAAQ,GAAA,CAAI,OAAA,KAAY,MAAA;AAIxC,IAAA,IAAM,UAAeA,eAAA,CAAA,UAAA,CAAW,QAAQ,CAAA,GAAI,QAAA,GAAgBA,wBAAQ,QAAQ,CAAA;AAG5E,IAAA,IAAI,CAAIC,aAAA,CAAA,UAAA,CAAW,OAAO,CAAA,EAAG;AAC3B,MAAA,MAAM,QAAQ,IAAI,KAAA;AAAA,QAChB,6BAA6B,OAAO;AAAA,iBAAA,EAChB,OAAA,CAAQ,GAAA,CAAI,SAAA,IAAa,WAAW;AAAA,OAAA,EAC9C,OAAA,CAAQ,KAAK;AAAA,eAAA,EACL,OAAO,CAAA;AAAA,OAC3B;AACA,MAAA,OAAA,CAAQ,KAAA,CAAM,cAAA,EAAgB,KAAA,CAAM,OAAO,CAAA;AAC3C,MAAA,OAAA,CAAQ,OAAO,EAAE,IAAA,EAAM,SAAS,KAAA,EAAO,KAAA,CAAM,SAAS,CAAA;AACtD,MAAA,OAAA,CAAQ,KAAK,CAAC,CAAA;AAAA,IAChB;AAEA,IAAA,OAAA,CAAQ,MAAM,OAAO,CAAA;AAErB,IAAA,SAAS,OAAO,IAAA,EAAiB;AAC/B,MAAA,IAAI,OAAA,EAAS,OAAA,CAAQ,KAAA,CAAM,cAAA,EAAgB,GAAG,IAAI,CAAA;AAAA,IACpD;AAEA,IAAA,IAAM,UAAN,MAAc;AAAA,MACZ,UAAA,GAAa,CAAA;AAAA,MACb,MAAA,GAAS,CAAA;AAAA,MACT,YAAA,GAAe,EAAA;AAAA,MACf,QAAA,GAAoB,IAAA;AAAA,MACpB,YAAA,GAAe,EAAA;AAAA,MACf,MAAA,GAA8B,IAAA;AAAA,MAC9B,OAAA,GAAyC,IAAA;AAAA,MACzC,kBAAA,GAA0C,IAAA;AAAA,MAClC,IAAA,GAAO,EAAA;AAAA,MAEf,IAAA,CAAK,IAAY,GAAA,EAAa;AAAE,QAAA,IAAA,CAAK,IAAA,GAAO,GAAA;AAAK,QAAA,IAAA,CAAK,UAAA,GAAa,CAAA;AAAA,MAAG;AAAA,MACtE,gBAAA,GAAmB;AAAA,MAAE;AAAA,MACrB,gBAAA,GAAmB;AAAA,MAAE;AAAA,MACrB,IAAA,GAAO;AACL,QAAA,IAAI;AACF,UAAA,MAAM,IAAA,GAAUA,aAAA,CAAA,YAAA,CAAa,IAAA,CAAK,IAAI,CAAA;AACtC,UAAA,IAAA,CAAK,MAAA,GAAS,GAAA;AACd,UAAA,IAAA,CAAK,UAAA,GAAa,CAAA;AAClB,UAAA,IAAI,IAAA,CAAK,iBAAiB,aAAA,EAAe;AACvC,YAAA,IAAA,CAAK,QAAA,GAAW,KAAK,MAAA,CAAO,KAAA,CAAM,KAAK,UAAA,EAAY,IAAA,CAAK,UAAA,GAAa,IAAA,CAAK,UAAU,CAAA;AAAA,UACtF,CAAA,MAAO;AACL,YAAA,IAAA,CAAK,YAAA,GAAe,IAAA,CAAK,QAAA,CAAS,MAAM,CAAA;AACxC,YAAA,IAAA,CAAK,WAAW,IAAA,CAAK,YAAA;AAAA,UACvB;AACA,UAAA,IAAI,IAAA,CAAK,MAAA,EAAQ,IAAA,CAAK,MAAA,EAAO;AAC7B,UAAA,IAAI,IAAA,CAAK,kBAAA,EAAoB,IAAA,CAAK,kBAAA,EAAmB;AAAA,QACvD,SAAS,GAAA,EAAK;AACZ,UAAA,IAAA,CAAK,MAAA,GAAS,GAAA;AACd,UAAA,IAAA,CAAK,UAAA,GAAa,CAAA;AAClB,UAAA,IAAI,IAAA,CAAK,OAAA,EAAS,IAAA,CAAK,OAAA,CAAQ,GAAY,CAAA;AAAA,QAC7C;AAAA,MACF;AAAA,KACF;AAEA,IAAC,OAAe,cAAA,GAAiB,OAAA;AAEjC,IAAA,IAAI,MAAA,GAAc,IAAA;AAClB,IAAA,IAAI,MAAA,GAAS,CAAA;AACb,IAAA,IAAI,WAAA,GAAc,KAAA;AAElB,IAAA,SAAS,YAAY,GAAA,EAAqB;AACxC,MAAA,MAAM,OAAA,GAAU,IAAI,WAAA,EAAY;AAChC,MAAA,MAAM,KAAA,GAAQ,OAAA,CAAQ,MAAA,CAAO,GAAA,GAAM,IAAI,CAAA;AACvC,MAAA,MAAM,GAAA,GAAM,MAAA,CAAO,OAAA,CAAQ,KAAA,CAAM,MAAM,CAAA;AACvC,MAAA,MAAA,CAAO,MAAA,CAAO,GAAA,CAAI,KAAA,EAAO,GAAG,CAAA;AAC5B,MAAA,OAAO,GAAA;AAAA,IACT;AAEA,IAAA,SAAS,QAAQ,IAAA,EAAsB;AACrC,MAAA,OAAO,MAAA,CAAO,MAAA,CAAO,IAAA,IAAQ,CAAC,CAAA;AAAA,IAChC;AAEA,IAAA,SAAS,OAAA,GAAgB;AACvB,MAAA,GAAA,CAAI,qBAAqB,CAAA;AACzB,MAAA,MAAM,OAAA,GAAU,YAAY,kBAAkB,CAAA;AAC9C,MAAA,IAAI,OAAO,YAAA,EAAc;AACvB,QAAA,MAAA,CAAO,YAAA,CAAa,SAAS,CAAC,CAAA;AAAA,MAChC;AACA,MAAA,MAAA,GAAS,MAAA,CAAO,qBAAqB,OAAO,CAAA;AAC5C,MAAA,MAAA,CAAO,MAAM,OAAO,CAAA;AACpB,MAAA,IAAI,MAAA,KAAW,CAAA,EAAG,MAAM,IAAI,MAAM,iBAAiB,CAAA;AACnD,MAAA,GAAA,CAAI,mBAAmB,MAAM,CAAA;AAC7B,MAAA,WAAA,GAAc,IAAA;AAAA,IAChB;AAEA,IAAA,SAAS,OAAA,CACP,SAAA,EACA,QAAA,EACA,YAAA,EACA,aAAA,EACU;AACV,MAAA,IAAI,CAAC,WAAA,EAAa,MAAM,IAAI,MAAM,iBAAiB,CAAA;AAEnD,MAAA,MAAM,SAAA,GAAY,kBAAkB,QAAQ,CAAA,CAAA;AAC5C,MAAA,MAAM,UAAA,GAAa,mBAAmB,YAAY,CAAA,CAAA;AAElD,MAAA,IAAI;AAAE,QAAA,MAAA,CAAO,EAAA,CAAG,MAAM,MAAM,CAAA;AAAA,MAAG,CAAA,CAAA,MAAQ;AAAA,MAAE;AACzC,MAAA,IAAI;AAAE,QAAA,MAAA,CAAO,EAAA,CAAG,MAAM,YAAY,CAAA;AAAA,MAAG,CAAA,CAAA,MAAQ;AAAA,MAAE;AAC/C,MAAA,IAAI;AAAE,QAAA,MAAA,CAAO,EAAA,CAAG,MAAM,aAAa,CAAA;AAAA,MAAG,CAAA,CAAA,MAAQ;AAAA,MAAE;AAEhD,MAAA,MAAA,CAAO,GAAG,SAAA,CAAU,SAAA,EAAW,IAAI,UAAA,CAAW,SAAS,CAAC,CAAA;AACxD,MAAA,GAAA,CAAI,eAAe,CAAA;AAEnB,MAAA,MAAM,WAAA,GAAc,QAAQ,MAAM,CAAA;AAClC,MAAA,MAAM,SAAA,GAAY,OAAA,CAAQ,WAAA,GAAc,CAAC,CAAA;AACzC,MAAA,MAAM,YAAY,MAAA,CAAO,SAAA;AACzB,MAAA,MAAM,MAAA,GAAS,SAAA,CAAU,GAAA,CAAI,SAAS,CAAA;AAEtC,MAAA,MAAM,YAAA,GAAe,YAAY,SAAS,CAAA;AAC1C,MAAA,MAAM,MAAA,GAAS,MAAA,CAAO,MAAA,EAAQ,YAAY,CAAA;AAC1C,MAAA,MAAA,CAAO,MAAM,YAAY,CAAA;AACzB,MAAA,IAAI,MAAA,KAAW,CAAA,EAAG,MAAM,IAAI,MAAM,yBAAyB,CAAA;AAC3D,MAAA,GAAA,CAAI,iBAAiB,CAAA;AAErB,MAAA,IAAI;AACF,QAAA,MAAM,WAAA,GAAc,QAAQ,MAAM,CAAA;AAClC,QAAA,MAAM,SAAA,GAAY,OAAA,CAAQ,WAAA,GAAc,CAAC,CAAA;AACzC,QAAA,MAAM,MAAA,GAAS,SAAA,CAAU,GAAA,CAAI,SAAS,CAAA;AAEtC,QAAA,MAAM,UAAA,GAAa,YAAY,UAAU,CAAA;AACzC,QAAA,MAAM,MAAA,GAAS,YAAY,YAAY,CAAA;AACvC,QAAA,MAAM,MAAA,GAAS,YAAY,aAAa,CAAA;AAExC,QAAA,MAAM,MAAA,GAAS,MAAA,CAAO,MAAA,EAAQ,UAAA,EAAY,QAAQ,MAAM,CAAA;AACxD,QAAA,MAAA,CAAO,MAAM,UAAU,CAAA;AACvB,QAAA,MAAA,CAAO,MAAM,MAAM,CAAA;AACnB,QAAA,MAAA,CAAO,MAAM,MAAM,CAAA;AAEnB,QAAA,IAAI,MAAA,KAAW,CAAA,EAAG,MAAM,IAAI,MAAM,gBAAgB,CAAA;AAClD,QAAA,GAAA,CAAI,gBAAgB,CAAA;AAEpB,QAAA,MAAM,MAAA,GAAS,MAAA,CAAO,EAAA,CAAG,QAAA,CAAS,UAAU,CAAA;AAC5C,QAAA,IAAI;AAAE,UAAA,MAAA,CAAO,EAAA,CAAG,OAAO,SAAS,CAAA;AAAA,QAAG,CAAA,CAAA,MAAQ;AAAA,QAAE;AAC7C,QAAA,IAAI;AAAE,UAAA,MAAA,CAAO,EAAA,CAAG,OAAO,UAAU,CAAA;AAAA,QAAG,CAAA,CAAA,MAAQ;AAAA,QAAE;AAE9C,QAAA,OAAO,KAAA,CAAM,KAAK,MAAM,CAAA;AAAA,MAC1B,CAAA,SAAE;AACA,QAAA,MAAM,WAAA,GAAc,QAAQ,MAAM,CAAA;AAClC,QAAA,MAAM,YAAA,GAAe,OAAA,CAAQ,WAAA,GAAc,CAAC,CAAA;AAC5C,QAAA,IAAI,iBAAiB,CAAA,EAAG;AACtB,UAAA,MAAM,SAAA,GAAY,SAAA,CAAU,GAAA,CAAI,YAAY,CAAA;AAC5C,UAAA,SAAA,CAAU,MAAM,CAAA;AAAA,QAClB;AAAA,MACF;AAAA,IACF;AAGA,IAAA,OAAA,CAAQ,EAAA,CAAG,SAAA,EAAW,CAAC,GAAA,KAAqD;AAC1E,MAAA,IAAI;AACF,QAAA,IAAI,GAAA,CAAI,SAAS,SAAA,EAAW;AAC1B,UAAA,MAAM,EAAE,SAAA,EAAW,QAAA,EAAU,YAAA,EAAc,aAAA,KAAkB,GAAA,CAAI,OAAA;AACjE,UAAA,MAAM,SAAS,OAAA,CAAQ,SAAA,EAAW,QAAA,EAAU,YAAA,EAAc,iBAAiB,EAAE,CAAA;AAC7E,UAAA,OAAA,CAAQ,IAAA,GAAO,EAAE,IAAA,EAAM,UAAA,EAAY,EAAA,EAAI,GAAA,CAAI,EAAA,EAAI,OAAA,EAAS,IAAA,EAAM,IAAA,EAAM,MAAA,EAAQ,CAAA;AAAA,QAC9E,CAAA,MAAA,IAAW,GAAA,CAAI,IAAA,KAAS,SAAA,EAAW;AACjC,UAAA,IAAI,MAAA,KAAW,KAAK,MAAA,EAAQ;AAC1B,YAAA,MAAM,WAAA,GAAc,QAAQ,MAAM,CAAA;AAClC,YAAA,MAAM,YAAA,GAAe,OAAA,CAAQ,WAAA,GAAc,CAAC,CAAA;AAC5C,YAAA,IAAI,iBAAiB,CAAA,EAAG;AACtB,cAAA,MAAM,YAAY,MAAA,CAAO,SAAA;AACzB,cAAA,MAAM,SAAA,GAAY,SAAA,CAAU,GAAA,CAAI,YAAY,CAAA;AAC5C,cAAA,SAAA,CAAU,MAAM,CAAA;AAAA,YAClB;AACA,YAAA,MAAA,GAAS,CAAA;AAAA,UACX;AACA,UAAA,WAAA,GAAc,KAAA;AACd,UAAA,OAAA,CAAQ,IAAA,GAAO,EAAE,IAAA,EAAM,UAAA,EAAY,IAAI,GAAA,CAAI,EAAA,EAAI,OAAA,EAAS,IAAA,EAAM,CAAA;AAE9D,UAAA,GAAA,CAAI,mCAAmC,CAAA;AACvC,UAAA,YAAA,CAAa,MAAM,OAAA,CAAQ,IAAA,CAAK,CAAC,CAAC,CAAA;AAAA,QACpC;AAAA,MACF,SAAS,GAAA,EAAK;AACZ,QAAA,OAAA,CAAQ,IAAA,GAAO,EAAE,IAAA,EAAM,UAAA,EAAY,EAAA,EAAI,GAAA,CAAI,EAAA,EAAI,OAAA,EAAS,KAAA,EAAO,KAAA,EAAQ,GAAA,CAAc,OAAA,EAAS,CAAA;AAAA,MAChG;AAAA,IACF,CAAC,CAAA;AAGD,IAAC,OAAe,MAAA,GAAS;AAAA,MACvB,UAAA,EAAY,CAAC,CAAA,KAAc,CAAA;AAAA,MAC3B,KAAA,EAAO,OAAA,GAAU,OAAA,CAAQ,GAAA,GAAM,MAAM;AAAA,MAAE,CAAA;AAAA,MACvC,QAAA,EAAU,OAAA,GAAU,OAAA,CAAQ,KAAA,GAAQ,MAAM;AAAA,MAAE;AAAA,KAC9C;AAEA,IAAA,GAAA,CAAI,6BAA6B,OAAO,CAAA;AAExC,IAAA,IAAM,EAAE,aAAA,EAAc,GAAI,SAAA,CAAQ,QAAQ,CAAA;AAC1C,IAAA,IAAM,WAAA,GAAc,cAAc,UAAU,CAAA;AAC5C,IAAA,WAAA,CAAiBD,eAAA,CAAA,IAAA,CAAK,OAAA,EAAS,aAAa,CAAC,CAAA;AAE7C,IAAA,GAAA,CAAI,2CAA2C,CAAA;AAG/C,IAAA,SAAS,UAAA,GAAa;AACpB,MAAA,MAAA,GAAU,MAAA,CAAe,MAAA;AAEzB,MAAA,IAAI,MAAA,CAAO,OAAA,IAAW,MAAA,CAAO,oBAAA,EAAsB;AACjD,QAAA,GAAA,CAAI,4BAA4B,CAAA;AAChC,QAAA,IAAI;AACF,UAAA,OAAA,EAAQ;AACR,UAAA,OAAA,CAAQ,IAAA,GAAO,EAAE,IAAA,EAAM,OAAA,EAAS,CAAA;AAChC,UAAA,GAAA,CAAI,yBAAyB,CAAA;AAAA,QAC/B,SAAS,GAAA,EAAK;AACZ,UAAA,GAAA,CAAI,eAAe,GAAG,CAAA;AACtB,UAAA,OAAA,CAAQ,OAAO,EAAE,IAAA,EAAM,SAAS,KAAA,EAAQ,GAAA,CAAc,SAAS,CAAA;AAAA,QACjE;AAAA,MACF,CAAA,MAAO;AAEL,QAAA,UAAA,CAAW,YAAY,GAAG,CAAA;AAAA,MAC5B;AAAA,IACF;AAGA,IAAA,UAAA,CAAW,YAAY,GAAG,CAAA;AAG1B,IAAA,WAAA,CAAY,MAAM;AAAA,IAAE,GAAG,GAAK,CAAA;AAAA,EAAA;AAAA,CAAA,CAAA","file":"fork-worker.cjs","sourcesContent":["/**\n * Forked Process Worker for LibreOffice WASM\n */\n\nimport * as path from 'path';\nimport * as fs from 'fs';\n\nconst wasmPath = process.env.WASM_PATH || './wasm';\nconst verbose = process.env.VERBOSE === 'true';\n\n// WASM_PATH from parent should already be absolute - only resolve if relative\n// This prevents double-pathing issues (e.g., /wasm/wasm) when CWD is already the wasm dir\nconst wasmDir = path.isAbsolute(wasmPath) ? wasmPath : path.resolve(wasmPath);\n\n// Verify the wasm directory exists before attempting to chdir\nif (!fs.existsSync(wasmDir)) {\n  const error = new Error(\n    `WASM directory not found: ${wasmDir}\\n` +\n    `  WASM_PATH env: ${process.env.WASM_PATH || '(not set)'}\\n` +\n    `  CWD: ${process.cwd()}\\n` +\n    `  Resolved to: ${wasmDir}`\n  );\n  console.error('[ForkWorker]', error.message);\n  process.send?.({ type: 'error', error: error.message });\n  process.exit(1);\n}\n\nprocess.chdir(wasmDir);\n\nfunction log(...args: unknown[]) {\n  if (verbose) console.error('[ForkWorker]', ...args);\n}\n\nclass NodeXHR {\n  readyState = 0;\n  status = 0;\n  responseType = '';\n  response: unknown = null;\n  responseText = '';\n  onload: (() => void) | null = null;\n  onerror: ((err: Error) => void) | null = null;\n  onreadystatechange: (() => void) | null = null;\n  private _url = '';\n\n  open(_m: string, url: string) { this._url = url; this.readyState = 1; }\n  overrideMimeType() { }\n  setRequestHeader() { }\n  send() {\n    try {\n      const data = fs.readFileSync(this._url);\n      this.status = 200;\n      this.readyState = 4;\n      if (this.responseType === 'arraybuffer') {\n        this.response = data.buffer.slice(data.byteOffset, data.byteOffset + data.byteLength);\n      } else {\n        this.responseText = data.toString('utf8');\n        this.response = this.responseText;\n      }\n      if (this.onload) this.onload();\n      if (this.onreadystatechange) this.onreadystatechange();\n    } catch (err) {\n      this.status = 404;\n      this.readyState = 4;\n      if (this.onerror) this.onerror(err as Error);\n    }\n  }\n}\n\n(global as any).XMLHttpRequest = NodeXHR;\n\nlet Module: any = null;\nlet lokPtr = 0;\nlet initialized = false;\n\nfunction allocString(str: string): number {\n  const encoder = new TextEncoder();\n  const bytes = encoder.encode(str + '\\0');\n  const ptr = Module._malloc(bytes.length);\n  Module.HEAPU8.set(bytes, ptr);\n  return ptr;\n}\n\nfunction readPtr(addr: number): number {\n  return Module.HEAP32[addr >> 2];\n}\n\nfunction initLOK(): void {\n  log('Initializing LOK...');\n  const pathPtr = allocString('/instdir/program');\n  if (Module._lok_preinit) {\n    Module._lok_preinit(pathPtr, 0);\n  }\n  lokPtr = Module._libreofficekit_hook(pathPtr);\n  Module._free(pathPtr);\n  if (lokPtr === 0) throw new Error('LOK init failed');\n  log('LOK ready, ptr:', lokPtr);\n  initialized = true;\n}\n\nfunction convert(\n  inputData: number[],\n  inputExt: string,\n  outputFormat: string,\n  filterOptions: string\n): number[] {\n  if (!initialized) throw new Error('Not initialized');\n\n  const inputPath = `/tmp/input/doc.${inputExt}`;\n  const outputPath = `/tmp/output/doc.${outputFormat}`;\n\n  try { Module.FS.mkdir('/tmp'); } catch { }\n  try { Module.FS.mkdir('/tmp/input'); } catch { }\n  try { Module.FS.mkdir('/tmp/output'); } catch { }\n\n  Module.FS.writeFile(inputPath, new Uint8Array(inputData));\n  log('Input written');\n\n  const lokClassPtr = readPtr(lokPtr);\n  const loadFnPtr = readPtr(lokClassPtr + 8);\n  const wasmTable = Module.wasmTable as WebAssembly.Table;\n  const loadFn = wasmTable.get(loadFnPtr) as (lok: number, path: number) => number;\n\n  const inputPathPtr = allocString(inputPath);\n  const docPtr = loadFn(lokPtr, inputPathPtr);\n  Module._free(inputPathPtr);\n  if (docPtr === 0) throw new Error('Failed to load document');\n  log('Document loaded');\n\n  try {\n    const docClassPtr = readPtr(docPtr);\n    const saveFnPtr = readPtr(docClassPtr + 8);\n    const saveFn = wasmTable.get(saveFnPtr) as (d: number, p: number, f: number, o: number) => number;\n\n    const outPathPtr = allocString(outputPath);\n    const fmtPtr = allocString(outputFormat);\n    const optPtr = allocString(filterOptions);\n\n    const result = saveFn(docPtr, outPathPtr, fmtPtr, optPtr);\n    Module._free(outPathPtr);\n    Module._free(fmtPtr);\n    Module._free(optPtr);\n\n    if (result === 0) throw new Error('Failed to save');\n    log('Document saved');\n\n    const output = Module.FS.readFile(outputPath) as Uint8Array;\n    try { Module.FS.unlink(inputPath); } catch { }\n    try { Module.FS.unlink(outputPath); } catch { }\n\n    return Array.from(output);\n  } finally {\n    const docClassPtr = readPtr(docPtr);\n    const destroyFnPtr = readPtr(docClassPtr + 4);\n    if (destroyFnPtr !== 0) {\n      const destroyFn = wasmTable.get(destroyFnPtr) as (d: number) => void;\n      destroyFn(docPtr);\n    }\n  }\n}\n\n// Handle messages\nprocess.on('message', (msg: { type: string; id: string; payload?: any }) => {\n  try {\n    if (msg.type === 'convert') {\n      const { inputData, inputExt, outputFormat, filterOptions } = msg.payload;\n      const result = convert(inputData, inputExt, outputFormat, filterOptions || '');\n      process.send?.({ type: 'response', id: msg.id, success: true, data: result });\n    } else if (msg.type === 'destroy') {\n      if (lokPtr !== 0 && Module) {\n        const lokClassPtr = readPtr(lokPtr);\n        const destroyFnPtr = readPtr(lokClassPtr + 4);\n        if (destroyFnPtr !== 0) {\n          const wasmTable = Module.wasmTable as WebAssembly.Table;\n          const destroyFn = wasmTable.get(destroyFnPtr) as (lok: number) => void;\n          destroyFn(lokPtr);\n        }\n        lokPtr = 0;\n      }\n      initialized = false;\n      process.send?.({ type: 'response', id: msg.id, success: true });\n      // Exit the process after cleanup - use setImmediate to allow response to be sent first\n      log('Destroy complete, exiting process');\n      setImmediate(() => process.exit(0));\n    }\n  } catch (err) {\n    process.send?.({ type: 'response', id: msg.id, success: false, error: (err as Error).message });\n  }\n});\n\n// Configure module\n(global as any).Module = {\n  locateFile: (f: string) => f,\n  print: verbose ? console.log : () => { },\n  printErr: verbose ? console.error : () => { },\n};\n\nlog('Loading WASM module from:', wasmDir);\n\nconst { createRequire } = require('module');\nconst nodeRequire = createRequire(__filename);\nnodeRequire(path.join(wasmDir, 'soffice.cjs'));\n\nlog('Module loaded, polling for ready state...');\n\n// Poll for the module to be ready\nfunction checkReady() {\n  Module = (global as any).Module;\n\n  if (Module._malloc && Module._libreofficekit_hook) {\n    log('Module functions available');\n    try {\n      initLOK();\n      process.send?.({ type: 'ready' });\n      log('Initialization complete');\n    } catch (err) {\n      log('Init error:', err);\n      process.send?.({ type: 'error', error: (err as Error).message });\n    }\n  } else {\n    // Keep polling\n    setTimeout(checkReady, 100);\n  }\n}\n\n// Start polling after a short delay\nsetTimeout(checkReady, 500);\n\n// Keep process alive\nsetInterval(() => { }, 60000);\n"]}