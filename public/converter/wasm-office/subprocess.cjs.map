{"version":3,"sources":["../src/subprocess.cts"],"names":["fs","require","createRequire","path"],"mappings":"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","file":"subprocess.cjs","sourcesContent":["/**\n * LibreOffice WASM Subprocess Script\n * \n * This runs as a child process to handle the WASM module.\n * The subprocess CAN change working directory which is required\n * for Emscripten's data file loading.\n */\n\nimport * as path from 'path';\nimport * as fs from 'fs';\nimport { createRequire } from 'module';\n\ninterface Message {\n  type: 'init' | 'convert' | 'destroy';\n  id: string;\n  payload?: unknown;\n}\n\ninterface InitPayload {\n  wasmPath: string;\n  verbose: boolean;\n}\n\ninterface ConvertPayload {\n  inputData: number[];\n  inputExt: string;\n  outputFormat: string;\n  filterOptions: string;\n}\n\n// Global state\nlet Module: any = null;\nlet lokPtr: number = 0;\nlet initialized = false;\n\n/**\n * XMLHttpRequest polyfill\n */\nclass NodeXMLHttpRequest {\n  readyState = 0;\n  status = 0;\n  responseType = '';\n  response: any = null;\n  responseText = '';\n  onload: (() => void) | null = null;\n  onerror: ((err: any) => void) | null = null;\n  onreadystatechange: (() => void) | null = null;\n  private _url = '';\n\n  open(_method: string, url: string) {\n    this._url = url;\n    this.readyState = 1;\n  }\n\n  overrideMimeType() {}\n  setRequestHeader() {}\n\n  send() {\n    try {\n      const data = fs.readFileSync(this._url);\n      this.status = 200;\n      this.readyState = 4;\n      if (this.responseType === 'arraybuffer') {\n        this.response = data.buffer.slice(data.byteOffset, data.byteOffset + data.byteLength);\n      } else {\n        this.responseText = data.toString('utf8');\n        this.response = this.responseText;\n      }\n      if (this.onload) this.onload();\n      if (this.onreadystatechange) this.onreadystatechange();\n    } catch (err) {\n      this.status = 404;\n      this.readyState = 4;\n      if (this.onerror) this.onerror(err);\n    }\n  }\n}\n\nfunction allocString(str: string): number {\n  const encoder = new TextEncoder();\n  const bytes = encoder.encode(str + '\\0');\n  const ptr = Module._malloc(bytes.length);\n  Module.HEAPU8.set(bytes, ptr);\n  return ptr;\n}\n\nfunction readPtr(addr: number): number {\n  return Module.HEAP32[addr >> 2];\n}\n\nasync function initialize(payload: InitPayload): Promise<void> {\n  if (initialized) return;\n\n  const verbose = payload.verbose;\n  \n  // Set up polyfill\n  (global as any).XMLHttpRequest = NodeXMLHttpRequest;\n\n  // Configure module\n  (global as any).Module = {\n    print: verbose ? console.log : () => {},\n    printErr: verbose ? console.error : () => {},\n  };\n\n  // Load the module (cwd is already set to wasm directory)\n  // Use createRequire to get a require function that works in ESM\n  const require = createRequire(import.meta.url);\n  const sofficeModule = require(path.join(process.cwd(), 'soffice.cjs'));\n  Module = (global as any).Module || sofficeModule;\n\n  // Wait for initialization\n  const start = Date.now();\n  const timeout = 120000;\n  \n  while (!Module._malloc || !Module._libreofficekit_hook) {\n    if (Date.now() - start > timeout) {\n      throw new Error('WASM init timeout');\n    }\n    await new Promise(r => setTimeout(r, 100));\n  }\n\n  // Initialize LOK\n  const pathPtr = allocString('/instdir/program');\n  if (Module._lok_preinit) {\n    Module._lok_preinit(pathPtr, 0);\n  }\n  lokPtr = Module._libreofficekit_hook(pathPtr);\n  Module._free(pathPtr);\n\n  if (lokPtr === 0) {\n    throw new Error('Failed to init LOK');\n  }\n\n  initialized = true;\n}\n\nasync function convert(payload: ConvertPayload): Promise<number[]> {\n  if (!initialized || !Module || lokPtr === 0) {\n    throw new Error('Not initialized');\n  }\n\n  const inputPath = `/tmp/input/doc.${payload.inputExt}`;\n  const outputPath = `/tmp/output/doc.${payload.outputFormat}`;\n\n  // Ensure directories exist\n  try { Module.FS.mkdir('/tmp'); } catch {}\n  try { Module.FS.mkdir('/tmp/input'); } catch {}\n  try { Module.FS.mkdir('/tmp/output'); } catch {}\n\n  // Write input\n  const inputData = new Uint8Array(payload.inputData);\n  Module.FS.writeFile(inputPath, inputData);\n\n  // Load document\n  const lokClassPtr = readPtr(lokPtr);\n  const loadFnPtr = readPtr(lokClassPtr + 8);\n  \n  const wasmTable = Module.wasmTable as WebAssembly.Table;\n  const loadFn = wasmTable.get(loadFnPtr) as (lok: number, path: number) => number;\n  \n  const inputPathPtr = allocString(inputPath);\n  const docPtr = loadFn(lokPtr, inputPathPtr);\n  Module._free(inputPathPtr);\n\n  if (docPtr === 0) {\n    throw new Error('Failed to load document');\n  }\n\n  try {\n    // Save document\n    const docClassPtr = readPtr(docPtr);\n    const saveFnPtr = readPtr(docClassPtr + 8);\n    const saveFn = wasmTable.get(saveFnPtr) as (\n      doc: number, path: number, format: number, opts: number\n    ) => number;\n\n    const outputPathPtr = allocString(outputPath);\n    const formatPtr = allocString(payload.outputFormat);\n    const optsPtr = allocString(payload.filterOptions);\n\n    const result = saveFn(docPtr, outputPathPtr, formatPtr, optsPtr);\n\n    Module._free(outputPathPtr);\n    Module._free(formatPtr);\n    Module._free(optsPtr);\n\n    if (result === 0) {\n      throw new Error('Failed to save document');\n    }\n\n    // Read output\n    const outputData = Module.FS.readFile(outputPath) as Uint8Array;\n    \n    // Cleanup\n    try { Module.FS.unlink(inputPath); } catch {}\n    try { Module.FS.unlink(outputPath); } catch {}\n\n    return Array.from(outputData);\n  } finally {\n    // Destroy document\n    const docClassPtr = readPtr(docPtr);\n    const destroyFnPtr = readPtr(docClassPtr + 4);\n    if (destroyFnPtr !== 0) {\n      const destroyFn = wasmTable.get(destroyFnPtr) as (doc: number) => void;\n      destroyFn(docPtr);\n    }\n  }\n}\n\n// Message handler\nprocess.on('message', async (msg: Message) => {\n  try {\n    switch (msg.type) {\n      case 'init':\n        await initialize(msg.payload as InitPayload);\n        process.send?.({ type: 'response', id: msg.id, success: true });\n        break;\n\n      case 'convert':\n        const result = await convert(msg.payload as ConvertPayload);\n        process.send?.({ type: 'response', id: msg.id, success: true, data: result });\n        break;\n\n      case 'destroy':\n        if (lokPtr !== 0 && Module) {\n          const lokClassPtr = readPtr(lokPtr);\n          const destroyFnPtr = readPtr(lokClassPtr + 4);\n          if (destroyFnPtr !== 0) {\n            const wasmTable = Module.wasmTable as WebAssembly.Table;\n            const destroyFn = wasmTable.get(destroyFnPtr) as (lok: number) => void;\n            destroyFn(lokPtr);\n          }\n          lokPtr = 0;\n        }\n        initialized = false;\n        process.send?.({ type: 'response', id: msg.id, success: true });\n        break;\n    }\n  } catch (error) {\n    process.send?.({ \n      type: 'response', \n      id: msg.id, \n      success: false, \n      error: (error as Error).message \n    });\n  }\n});\n\n// Signal ready\nprocess.send?.({ type: 'ready' });\n\n"]}