var F="/wasm/";function w(c=F){let e=c.endsWith("/")?c:`${c}/`;return {sofficeJs:`${e}soffice.js`,sofficeWasm:`${e}soffice.wasm`,sofficeData:`${e}soffice.data`,sofficeWorkerJs:`${e}soffice.worker.js`}}var L=(a=>(a.UNKNOWN="UNKNOWN",a.INVALID_INPUT="INVALID_INPUT",a.UNSUPPORTED_FORMAT="UNSUPPORTED_FORMAT",a.CORRUPTED_DOCUMENT="CORRUPTED_DOCUMENT",a.PASSWORD_REQUIRED="PASSWORD_REQUIRED",a.WASM_NOT_INITIALIZED="WASM_NOT_INITIALIZED",a.CONVERSION_FAILED="CONVERSION_FAILED",a.LOAD_FAILED="LOAD_FAILED",a))(L||{}),d=class extends Error{code;details;constructor(e,t,r){super(t),this.name="ConversionError",this.code=e,this.details=r;}},y={pdf:"writer_pdf_Export",docx:"MS Word 2007 XML",doc:"MS Word 97",odt:"writer8",rtf:"Rich Text Format",txt:"Text",html:"HTML (StarWriter)",xlsx:"Calc MS Excel 2007 XML",xls:"MS Excel 97",ods:"calc8",csv:"Text - txt - csv (StarCalc)",pptx:"Impress MS PowerPoint 2007 XML",ppt:"MS PowerPoint 97",odp:"impress8",png:"writer_png_Export",jpg:"writer_jpg_Export",svg:"writer_svg_Export"};var T={pdf:"application/pdf",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",doc:"application/msword",odt:"application/vnd.oasis.opendocument.text",rtf:"application/rtf",txt:"text/plain",html:"text/html",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",xls:"application/vnd.ms-excel",ods:"application/vnd.oasis.opendocument.spreadsheet",csv:"text/csv",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation",ppt:"application/vnd.ms-powerpoint",odp:"application/vnd.oasis.opendocument.presentation",png:"image/png",jpg:"image/jpeg",svg:"image/svg+xml"},B={doc:"doc",docx:"docx",xls:"xls",xlsx:"xlsx",ppt:"ppt",pptx:"pptx",odt:"odt",ods:"ods",odp:"odp",odg:"odg",odf:"odf",rtf:"rtf",txt:"txt",html:"html",htm:"html",csv:"csv",xml:"xml",epub:"epub",pdf:"pdf"};var N={pdf:"pdf",docx:"docx",doc:"doc",odt:"odt",rtf:"rtf",txt:"txt",html:"html",xlsx:"xlsx",xls:"xls",ods:"ods",csv:"csv",pptx:"pptx",ppt:"ppt",odp:"odp",png:"png",jpg:"jpg",svg:"svg"},U={pdf:"",csv:"44,34,76,1,,0,false,true,false,false,false,-1",txt:"UTF8"};var _=class{lok;docPtr;options;inputPath="";constructor(e,t,r={}){this.lok=e,this.docPtr=t,this.options={maxResponseChars:r.maxResponseChars??8e3,...r};}getDocPtr(){return this.docPtr}getLokBindings(){return this.lok}save(){try{return this.inputPath?(this.lok.postUnoCommand(this.docPtr,".uno:Save"),this.createResult({path:this.inputPath})):this.createErrorResult("No input path set","Use saveAs() to specify a path")}catch(e){return this.createErrorResult(`Save failed: ${String(e)}`)}}saveAs(e,t){try{return this.lok.documentSaveAs(this.docPtr,e,t,""),this.createResult({path:e})}catch(r){return this.createErrorResult(`SaveAs failed: ${String(r)}`)}}close(){try{return this.lok.documentDestroy(this.docPtr),this.docPtr=0,this.createResult(void 0)}catch(e){return this.createErrorResult(`Close failed: ${String(e)}`)}}getEditMode(){return this.lok.getEditMode(this.docPtr)}enableEditMode(){try{if(this.lok.getEditMode(this.docPtr)===1)return this.createResult({editMode:1});this.lok.postUnoCommand(this.docPtr,".uno:Edit");let t=this.lok.getEditMode(this.docPtr);return {success:!0,verified:t===1,data:{editMode:t}}}catch(e){return this.createErrorResult(`Failed to enable edit mode: ${String(e)}`)}}undo(){try{return this.lok.postUnoCommand(this.docPtr,".uno:Undo"),this.createResult(void 0)}catch(e){return this.createErrorResult(`Undo failed: ${String(e)}`)}}redo(){try{return this.lok.postUnoCommand(this.docPtr,".uno:Redo"),this.createResult(void 0)}catch(e){return this.createErrorResult(`Redo failed: ${String(e)}`)}}find(e,t){try{let r=JSON.stringify({"SearchItem.SearchString":{type:"string",value:e},"SearchItem.Backward":{type:"boolean",value:!1},"SearchItem.SearchAll":{type:"boolean",value:!0},"SearchItem.MatchCase":{type:"boolean",value:t?.caseSensitive??!1},"SearchItem.WordOnly":{type:"boolean",value:t?.wholeWord??!1}});this.lok.postUnoCommand(this.docPtr,".uno:ExecuteSearch",r);let o=this.lok.getTextSelection(this.docPtr,"text/plain"),n=o!==null&&o.length>0;return this.createResult({matches:n?1:0,firstMatch:n?{x:0,y:0}:void 0})}catch(r){return this.createErrorResult(`Find failed: ${String(r)}`)}}findAndReplaceAll(e,t,r){try{let o=JSON.stringify({"SearchItem.SearchString":{type:"string",value:e},"SearchItem.ReplaceString":{type:"string",value:t},"SearchItem.Command":{type:"long",value:3},"SearchItem.MatchCase":{type:"boolean",value:r?.caseSensitive??!1},"SearchItem.WordOnly":{type:"boolean",value:r?.wholeWord??!1}});return this.lok.postUnoCommand(this.docPtr,".uno:ExecuteSearch",o),this.createResult({replacements:-1})}catch(o){return this.createErrorResult(`Replace failed: ${String(o)}`)}}getStateChanges(){try{let e=this.lok.pollStateChanges();return this.createResult(e)}catch(e){return this.createErrorResult(`Failed to poll state changes: ${String(e)}`)}}flushAndPollState(){try{this.lok.flushCallbacks(this.docPtr);let e=this.lok.pollStateChanges();return this.createResult(e)}catch(e){return this.createErrorResult(`Failed to flush and poll state: ${String(e)}`)}}clearCallbackQueue(){this.lok.clearCallbackQueue();}select(e){try{let t=this.lok.getTextSelection(this.docPtr,"text/plain");return this.createResult({selected:t||""})}catch(t){return this.createErrorResult(`Select failed: ${String(t)}`)}}getSelection(){try{let e=this.lok.getTextSelection(this.docPtr,"text/plain");return this.createResult({text:e||"",range:{type:"text",start:{paragraph:0,character:0}}})}catch(e){return this.createErrorResult(`GetSelection failed: ${String(e)}`)}}clearSelection(){try{return this.lok.resetSelection(this.docPtr),this.createResult(void 0)}catch(e){return this.createErrorResult(`ClearSelection failed: ${String(e)}`)}}createResult(e){return {success:true,verified:true,data:e}}createErrorResult(e,t){return {success:false,verified:false,error:e,suggestion:t}}createResultWithTruncation(e,t){return {success:true,verified:true,data:e,truncated:t}}truncateContent(e,t){let r=t??this.options.maxResponseChars,o=e.length;if(o<=r)return {content:e,truncated:false,original:o,returned:o};let n=e.slice(0,r),s=n.lastIndexOf(" ");return s>r*.8&&(n=n.slice(0,s)),{content:n,truncated:true,original:o,returned:n.length}}truncateArray(e,t,r){let o=e.length,n=0,s=0;for(let i of e){let a=r(i);if(n+a.length>t)break;n+=a.length,s++;}return {items:e.slice(0,s),truncated:s<o,original:o,returned:s}}a1ToRowCol(e){let t=e.match(/^([A-Z]+)(\d+)$/i);if(!t)throw new Error(`Invalid A1 notation: ${e}`);let r=t[1].toUpperCase(),o=t[2],n=0;for(let i=0;i<r.length;i++)n=n*26+(r.charCodeAt(i)-64);return n-=1,{row:parseInt(o,10)-1,col:n}}rowColToA1(e,t){let r="",o=t+1;for(;o>0;){let n=(o-1)%26;r=String.fromCharCode(65+n)+r,o=Math.floor((o-1)/26);}return `${r}${e+1}`}normalizeCellRef(e){return typeof e=="string"?this.a1ToRowCol(e):e}setInputPath(e){this.inputPath=e;}isOpen(){return this.docPtr!==0}};var C=class extends _{cachedParagraphs=null;getDocumentType(){return "writer"}getStructure(e){try{let t=this.getParagraphsInternal(),r=e?.maxResponseChars??this.options.maxResponseChars,o=t.map((i,a)=>({index:a,preview:i.slice(0,100)+(i.length>100?"...":""),style:"Normal",charCount:i.length})),n=this.truncateArray(o,r,i=>JSON.stringify(i)),s={type:"writer",paragraphs:n.items,pageCount:this.lok.documentGetParts(this.docPtr),wordCount:t.join(" ").split(/\s+/).filter(i=>i.length>0).length};return n.truncated?this.createResultWithTruncation(s,{original:n.original,returned:n.returned,message:`Showing ${n.returned} of ${n.original} paragraphs. Use getParagraphs(start, count) to paginate.`}):this.createResult(s)}catch(t){return this.createErrorResult(`Failed to get structure: ${String(t)}`)}}getParagraph(e){try{let t=this.getParagraphsInternal();if(e<0||e>=t.length)return this.createErrorResult(`Paragraph index ${e} out of range (0-${t.length-1})`,"Use getStructure() to see available paragraphs");let r=t[e];return this.createResult({index:e,text:r,style:"Normal",charCount:r.length})}catch(t){return this.createErrorResult(`Failed to get paragraph: ${String(t)}`)}}getParagraphs(e,t){try{let r=this.getParagraphsInternal();if(e<0||e>=r.length)return this.createErrorResult(`Start index ${e} out of range`,`Valid range: 0-${r.length-1}`);let o=Math.min(e+t,r.length),n=r.slice(e,o).map((s,i)=>({index:e+i,text:s,style:"Normal",charCount:s.length}));return this.createResult(n)}catch(r){return this.createErrorResult(`Failed to get paragraphs: ${String(r)}`)}}insertParagraph(e,t){try{let r=this.getParagraphsInternal(),o=t?.afterIndex!==void 0?t.afterIndex+1:r.length;o>0&&o<=r.length&&this.lok.postUnoCommand(this.docPtr,".uno:GoToEndOfDoc"),this.lok.postUnoCommand(this.docPtr,".uno:InsertPara");let n=JSON.stringify({Text:{type:"string",value:e}});if(this.lok.postUnoCommand(this.docPtr,".uno:InsertText",n),t?.style&&t.style!=="Normal"){let l={"Heading 1":"Heading 1","Heading 2":"Heading 2","Heading 3":"Heading 3",List:"List"}[t.style];if(l){let u=JSON.stringify({Template:{type:"string",value:l},Family:{type:"short",value:2}});this.lok.postUnoCommand(this.docPtr,".uno:StyleApply",u);}}return this.cachedParagraphs=null,{success:!0,verified:this.getParagraphsInternal().length>r.length,data:{index:o}}}catch(r){return this.createErrorResult(`Failed to insert paragraph: ${String(r)}`)}}replaceParagraph(e,t){try{let r=this.getParagraphsInternal();if(e<0||e>=r.length)return this.createErrorResult(`Paragraph index ${e} out of range`,`Valid range: 0-${r.length-1}`);let o=r[e],n=JSON.stringify({"SearchItem.SearchString":{type:"string",value:o},"SearchItem.ReplaceString":{type:"string",value:t},"SearchItem.Command":{type:"long",value:2}});return this.lok.postUnoCommand(this.docPtr,".uno:ExecuteSearch",n),this.cachedParagraphs=null,this.createResult({oldText:o})}catch(r){return this.createErrorResult(`Failed to replace paragraph: ${String(r)}`)}}deleteParagraph(e){try{let t=this.getParagraphsInternal();if(e<0||e>=t.length)return this.createErrorResult(`Paragraph index ${e} out of range`,`Valid range: 0-${t.length-1}`);let r=t[e],o=this.replaceParagraph(e,"");return o.success?this.createResult({deletedText:r}):this.createErrorResult(o.error||"Failed to delete")}catch(t){return this.createErrorResult(`Failed to delete paragraph: ${String(t)}`)}}insertText(e,t){try{let r=JSON.stringify({Text:{type:"string",value:e}});return this.lok.postUnoCommand(this.docPtr,".uno:InsertText",r),this.cachedParagraphs=null,this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to insert text: ${String(r)}`)}}deleteText(e,t){try{let r=this.lok.getTextSelection(this.docPtr,"text/plain");return this.lok.postUnoCommand(this.docPtr,".uno:Delete"),this.cachedParagraphs=null,this.createResult({deleted:r||""})}catch(r){return this.createErrorResult(`Failed to delete text: ${String(r)}`)}}replaceText(e,t,r){try{let o=r?.all?3:2,n=JSON.stringify({"SearchItem.SearchString":{type:"string",value:e},"SearchItem.ReplaceString":{type:"string",value:t},"SearchItem.Command":{type:"long",value:o}});return this.lok.postUnoCommand(this.docPtr,".uno:ExecuteSearch",n),this.cachedParagraphs=null,this.createResult({replacements:-1})}catch(o){return this.createErrorResult(`Failed to replace text: ${String(o)}`)}}formatText(e,t){try{if(t.bold!==void 0&&this.lok.postUnoCommand(this.docPtr,".uno:Bold"),t.italic!==void 0&&this.lok.postUnoCommand(this.docPtr,".uno:Italic"),t.underline!==void 0&&this.lok.postUnoCommand(this.docPtr,".uno:Underline"),t.fontSize!==void 0){let r=JSON.stringify({FontHeight:{type:"float",value:t.fontSize}});this.lok.postUnoCommand(this.docPtr,".uno:FontHeight",r);}if(t.fontName!==void 0){let r=JSON.stringify({CharFontName:{type:"string",value:t.fontName}});this.lok.postUnoCommand(this.docPtr,".uno:CharFontName",r);}return this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to format text: ${String(r)}`)}}getFormat(e){try{this.lok.clearCallbackQueue(),this.lok.postUnoCommand(this.docPtr,".uno:CharRightSel"),this.lok.flushCallbacks(this.docPtr),this.lok.postUnoCommand(this.docPtr,".uno:CharLeft"),this.lok.flushCallbacks(this.docPtr);let t=this.lok.pollStateChanges(),r={},o=t.get(".uno:Bold");o!==void 0&&(r.bold=o==="true");let n=t.get(".uno:Italic");n!==void 0&&(r.italic=n==="true");let s=t.get(".uno:Underline");s!==void 0&&(r.underline=s==="true");let i=t.get(".uno:FontHeight");if(i!==void 0){let l=parseFloat(i);isNaN(l)||(r.fontSize=l);}let a=t.get(".uno:CharFontName");return a!==void 0&&a.length>0&&(r.fontName=a),this.createResult(r)}catch(t){return this.createErrorResult(`Failed to get format: ${String(t)}`)}}getSelectionFormat(){try{let e=this.lok.pollStateChanges();if(e.size===0){this.lok.clearCallbackQueue(),this.lok.postUnoCommand(this.docPtr,".uno:SelectWord"),this.lok.flushCallbacks(this.docPtr);let t=this.lok.pollStateChanges();return this.createResult(t)}return this.createResult(e)}catch(e){return this.createErrorResult(`Failed to get selection format: ${String(e)}`)}}getParagraphsInternal(){if(this.cachedParagraphs)return this.cachedParagraphs;let e=this.lok.getAllText(this.docPtr);return e?(this.cachedParagraphs=e.split(/\n\n|\r\n\r\n/).map(t=>t.trim()).filter(t=>t.length>0),this.cachedParagraphs):[]}};var O=class extends _{getDocumentType(){return "calc"}getStructure(e){try{let t=this.lok.documentGetParts(this.docPtr),r=[];for(let n=0;n<t;n++){let s=this.lok.getPartName(this.docPtr,n)||`Sheet${n+1}`,i=this.lok.getDataArea(this.docPtr,n);r.push({index:n,name:s,usedRange:i.col>0&&i.row>0?`A1:${this.rowColToA1(i.row-1,i.col-1)}`:"A1",rowCount:i.row,colCount:i.col});}let o={type:"calc",sheets:r};return this.createResult(o)}catch(t){return this.createErrorResult(`Failed to get structure: ${String(t)}`)}}getSheetNames(){try{let e=this.lok.documentGetParts(this.docPtr),t=[];for(let r=0;r<e;r++){let o=this.lok.getPartName(this.docPtr,r)||`Sheet${r+1}`;t.push(o);}return this.createResult(t)}catch(e){return this.createErrorResult(`Failed to get sheet names: ${String(e)}`)}}getCell(e,t){try{this.selectSheet(t);let{row:r,col:o}=this.normalizeCellRef(e),n=this.rowColToA1(r,o);this.goToCell(n);let s=this.getCellValueInternal(),i=this.getCellFormulaInternal();return this.createResult({address:n,value:s,formula:i||void 0})}catch(r){return this.createErrorResult(`Failed to get cell: ${String(r)}`)}}getCells(e,t,r){try{this.selectSheet(t);let{startRow:o,startCol:n,endRow:s,endCol:i}=this.normalizeRangeRef(e),a=r?.maxResponseChars??this.options.maxResponseChars,l=[],u=0,m=!1;for(let f=o;f<=s&&!m;f++){let h=[];for(let p=n;p<=i&&!m;p++){let g=this.rowColToA1(f,p);this.goToCell(g);let b=this.getCellValueInternal(),S={address:g,value:b},E=JSON.stringify(S);if(u+E.length>a){m=!0;break}u+=E.length,h.push(S);}h.length>0&&l.push(h);}return m?this.createResultWithTruncation(l,{original:(s-o+1)*(i-n+1),returned:l.reduce((f,h)=>f+h.length,0),message:"Range truncated due to size. Use smaller ranges to paginate."}):this.createResult(l)}catch(o){return this.createErrorResult(`Failed to get cells: ${String(o)}`)}}setCellValue(e,t,r){try{this.selectSheet(r);let{row:o,col:n}=this.normalizeCellRef(e),s=this.rowColToA1(o,n);this.goToCell(s);let i=this.getCellValueInternal(),a=typeof t=="number"?t.toString():t,l=JSON.stringify({StringName:{type:"string",value:a}});this.lok.postUnoCommand(this.docPtr,".uno:EnterString",l);let u=this.getCellValueInternal(),m=typeof t=="number"?t.toString():t;return {success:!0,verified:u===m||u===t,data:{oldValue:i,newValue:u}}}catch(o){return this.createErrorResult(`Failed to set cell value: ${String(o)}`)}}setCellFormula(e,t,r){try{this.selectSheet(r);let{row:o,col:n}=this.normalizeCellRef(e),s=this.rowColToA1(o,n);this.goToCell(s);let i=JSON.stringify({StringName:{type:"string",value:t}});this.lok.postUnoCommand(this.docPtr,".uno:EnterString",i);let a=this.getCellValueInternal();return this.createResult({calculatedValue:a})}catch(o){return this.createErrorResult(`Failed to set formula: ${String(o)}`)}}setCells(e,t,r){try{this.selectSheet(r);let{startRow:o,startCol:n}=this.normalizeRangeRef(e),s=0;for(let i=0;i<t.length;i++){let a=t[i];if(a)for(let l=0;l<a.length;l++){let u=a[l];if(u==null)continue;let m=this.rowColToA1(o+i,n+l);this.goToCell(m);let f=typeof u=="number"?u.toString():String(u),h=JSON.stringify({StringName:{type:"string",value:f}});this.lok.postUnoCommand(this.docPtr,".uno:EnterString",h),s++;}}return this.createResult({cellsUpdated:s})}catch(o){return this.createErrorResult(`Failed to set cells: ${String(o)}`)}}clearCell(e,t){try{this.selectSheet(t);let{row:r,col:o}=this.normalizeCellRef(e),n=this.rowColToA1(r,o);this.goToCell(n);let s=this.getCellValueInternal();return this.lok.postUnoCommand(this.docPtr,".uno:ClearContents"),this.createResult({oldValue:s})}catch(r){return this.createErrorResult(`Failed to clear cell: ${String(r)}`)}}clearRange(e,t){try{this.selectSheet(t);let r=this.normalizeRangeToString(e);this.goToCell(r),this.lok.postUnoCommand(this.docPtr,".uno:ClearContents");let{startRow:o,startCol:n,endRow:s,endCol:i}=this.normalizeRangeRef(e),a=(s-o+1)*(i-n+1);return this.createResult({cellsCleared:a})}catch(r){return this.createErrorResult(`Failed to clear range: ${String(r)}`)}}insertRow(e,t){try{return this.selectSheet(t),this.goToCell(this.rowColToA1(e+1,0)),this.lok.postUnoCommand(this.docPtr,".uno:InsertRows"),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to insert row: ${String(r)}`)}}insertColumn(e,t){try{this.selectSheet(t);let r=typeof e=="string"?this.a1ToRowCol(e+"1").col+1:e+1;return this.goToCell(this.rowColToA1(0,r)),this.lok.postUnoCommand(this.docPtr,".uno:InsertColumns"),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to insert column: ${String(r)}`)}}deleteRow(e,t){try{return this.selectSheet(t),this.goToCell(this.rowColToA1(e,0)),this.lok.postUnoCommand(this.docPtr,".uno:DeleteRows"),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to delete row: ${String(r)}`)}}deleteColumn(e,t){try{this.selectSheet(t);let r=typeof e=="string"?this.a1ToRowCol(e+"1").col:e;return this.goToCell(this.rowColToA1(0,r)),this.lok.postUnoCommand(this.docPtr,".uno:DeleteColumns"),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to delete column: ${String(r)}`)}}formatCells(e,t,r){try{this.selectSheet(r);let o=this.normalizeRangeToString(e);if(this.goToCell(o),t.bold!==void 0&&this.lok.postUnoCommand(this.docPtr,".uno:Bold"),t.numberFormat!==void 0){let n=JSON.stringify({NumberFormatValue:{type:"string",value:t.numberFormat}});this.lok.postUnoCommand(this.docPtr,".uno:NumberFormatValue",n);}if(t.backgroundColor!==void 0){let n=JSON.stringify({BackgroundColor:{type:"long",value:this.hexToNumber(t.backgroundColor)}});this.lok.postUnoCommand(this.docPtr,".uno:BackgroundColor",n);}return this.createResult(void 0)}catch(o){return this.createErrorResult(`Failed to format cells: ${String(o)}`)}}addSheet(e){try{let t=JSON.stringify({Name:{type:"string",value:e}});this.lok.postUnoCommand(this.docPtr,".uno:Insert",t);let r=this.lok.documentGetParts(this.docPtr);return this.createResult({index:r-1})}catch(t){return this.createErrorResult(`Failed to add sheet: ${String(t)}`)}}renameSheet(e,t){try{this.selectSheet(e);let r=JSON.stringify({Name:{type:"string",value:t}});return this.lok.postUnoCommand(this.docPtr,".uno:RenameTable",r),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to rename sheet: ${String(r)}`)}}deleteSheet(e){try{return this.selectSheet(e),this.lok.postUnoCommand(this.docPtr,".uno:Remove"),this.createResult(void 0)}catch(t){return this.createErrorResult(`Failed to delete sheet: ${String(t)}`)}}selectSheet(e){if(e===void 0)return;let t=typeof e=="number"?e:this.getSheetIndexByName(e);t>=0&&this.lok.documentSetPart(this.docPtr,t);}getSheetIndexByName(e){let t=this.lok.documentGetParts(this.docPtr);for(let r=0;r<t;r++)if(this.lok.getPartName(this.docPtr,r)===e)return r;return  -1}goToCell(e){let t=JSON.stringify({ToPoint:{type:"string",value:e}});this.lok.postUnoCommand(this.docPtr,".uno:GoToCell",t);}getCellValueInternal(){let e=this.lok.getTextSelection(this.docPtr,"text/plain");if(!e)return null;let t=parseFloat(e);return !isNaN(t)&&e.trim()===t.toString()?t:e.toLowerCase()==="true"?true:e.toLowerCase()==="false"?false:e}getCellFormulaInternal(){let e=this.lok.getCommandValues(this.docPtr,".uno:GetFormulaBarText");if(!e)return null;try{return JSON.parse(e).value??null}catch{return null}}normalizeRangeRef(e){if(typeof e=="string"){let o=e.split(":"),n=this.a1ToRowCol(o[0]),s=o[1]?this.a1ToRowCol(o[1]):n;return {startRow:n.row,startCol:n.col,endRow:s.row,endCol:s.col}}let t=this.normalizeCellRef(e.start),r=this.normalizeCellRef(e.end);return {startRow:t.row,startCol:t.col,endRow:r.row,endCol:r.col}}normalizeRangeToString(e){if(typeof e=="string")return e;let t=this.normalizeCellRef(e.start),r=this.normalizeCellRef(e.end);return `${this.rowColToA1(t.row,t.col)}:${this.rowColToA1(r.row,r.col)}`}hexToNumber(e){return parseInt(e.replace("#",""),16)}};var v=class extends _{getDocumentType(){return "impress"}getStructure(e){try{let t=this.lok.documentGetParts(this.docPtr),r=[];for(let n=0;n<t;n++){let s=this.getSlideInfoInternal(n);r.push(s);}let o={type:"impress",slides:r,slideCount:t};return this.createResult(o)}catch(t){return this.createErrorResult(`Failed to get structure: ${String(t)}`)}}getSlide(e){try{let t=this.lok.documentGetParts(this.docPtr);if(e<0||e>=t)return this.createErrorResult(`Invalid slide index: ${e}. Valid range: 0-${t-1}`,"Use getStructure() to see available slides");this.lok.documentSetPart(this.docPtr,e);let r=this.lok.getAllText(this.docPtr)||"",o=this.parseTextFrames(r),n={index:e,title:o.find(s=>s.type==="title")?.text,textFrames:o,hasNotes:!1};return this.createResult(n)}catch(t){return this.createErrorResult(`Failed to get slide: ${String(t)}`)}}getSlideCount(){try{let e=this.lok.documentGetParts(this.docPtr);return this.createResult(e)}catch(e){return this.createErrorResult(`Failed to get slide count: ${String(e)}`)}}addSlide(e){try{let t=this.lok.documentGetParts(this.docPtr);e?.afterSlide!==void 0?this.lok.documentSetPart(this.docPtr,e.afterSlide):this.lok.documentSetPart(this.docPtr,t-1),this.lok.postUnoCommand(this.docPtr,".uno:InsertPage"),e?.layout&&this.applySlideLayout(e.layout);let r=e?.afterSlide!==void 0?e.afterSlide+1:t;return {success:!0,verified:this.lok.documentGetParts(this.docPtr)>t,data:{index:r}}}catch(t){return this.createErrorResult(`Failed to add slide: ${String(t)}`)}}deleteSlide(e){try{let t=this.lok.documentGetParts(this.docPtr);return t<=1?this.createErrorResult("Cannot delete the last slide","A presentation must have at least one slide"):e<0||e>=t?this.createErrorResult(`Invalid slide index: ${e}`,`Valid range: 0-${t-1}`):(this.lok.documentSetPart(this.docPtr,e),this.lok.postUnoCommand(this.docPtr,".uno:DeletePage"),this.createResult(void 0))}catch(t){return this.createErrorResult(`Failed to delete slide: ${String(t)}`)}}duplicateSlide(e){try{let t=this.lok.documentGetParts(this.docPtr);return e<0||e>=t?this.createErrorResult(`Invalid slide index: ${e}`,`Valid range: 0-${t-1}`):(this.lok.documentSetPart(this.docPtr,e),this.lok.postUnoCommand(this.docPtr,".uno:DuplicatePage"),this.createResult({newIndex:e+1}))}catch(t){return this.createErrorResult(`Failed to duplicate slide: ${String(t)}`)}}moveSlide(e,t){try{let r=this.lok.documentGetParts(this.docPtr);if(e<0||e>=r||t<0||t>=r)return this.createErrorResult(`Invalid slide indices. Valid range: 0-${r-1}`,"Check slide indices are within bounds");if(e===t)return this.createErrorResult("Source and destination are the same","Provide different indices to move");this.lok.documentSetPart(this.docPtr,e);let o=JSON.stringify({Position:{type:"long",value:t}});return this.lok.postUnoCommand(this.docPtr,".uno:MovePageFirst",o),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to move slide: ${String(r)}`)}}setSlideTitle(e,t){try{let r=this.lok.documentGetParts(this.docPtr);if(e<0||e>=r)return this.createErrorResult(`Invalid slide index: ${e}`);this.lok.documentSetPart(this.docPtr,e);let o=this.lok.getAllText(this.docPtr)||"",s=this.parseTextFrames(o).find(a=>a.type==="title")?.text;this.lok.postUnoCommand(this.docPtr,".uno:SelectAll");let i=JSON.stringify({Text:{type:"string",value:t}});return this.lok.postUnoCommand(this.docPtr,".uno:InsertText",i),this.createResult({oldTitle:s})}catch(r){return this.createErrorResult(`Failed to set slide title: ${String(r)}`)}}setSlideBody(e,t){try{let r=this.lok.documentGetParts(this.docPtr);if(e<0||e>=r)return this.createErrorResult(`Invalid slide index: ${e}`);this.lok.documentSetPart(this.docPtr,e);let o=this.lok.getAllText(this.docPtr)||"",s=this.parseTextFrames(o).find(a=>a.type==="body")?.text;this.lok.postUnoCommand(this.docPtr,".uno:NextObject");let i=JSON.stringify({Text:{type:"string",value:t}});return this.lok.postUnoCommand(this.docPtr,".uno:InsertText",i),this.createResult({oldBody:s})}catch(r){return this.createErrorResult(`Failed to set slide body: ${String(r)}`)}}setSlideNotes(e,t){try{let r=this.lok.documentGetParts(this.docPtr);if(e<0||e>=r)return this.createErrorResult(`Invalid slide index: ${e}`);this.lok.documentSetPart(this.docPtr,e),this.lok.postUnoCommand(this.docPtr,".uno:NotesMode");let o=JSON.stringify({Text:{type:"string",value:t}});return this.lok.postUnoCommand(this.docPtr,".uno:InsertText",o),this.lok.postUnoCommand(this.docPtr,".uno:NormalViewMode"),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to set slide notes: ${String(r)}`)}}setSlideLayout(e,t){try{let r=this.lok.documentGetParts(this.docPtr);return e<0||e>=r?this.createErrorResult(`Invalid slide index: ${e}`):(this.lok.documentSetPart(this.docPtr,e),this.applySlideLayout(t),this.createResult(void 0))}catch(r){return this.createErrorResult(`Failed to set slide layout: ${String(r)}`)}}getSlideInfoInternal(e){this.lok.documentSetPart(this.docPtr,e);let t=this.lok.getAllText(this.docPtr)||"",r=this.parseTextFrames(t),o=r.find(n=>n.type==="title");return {index:e,title:o?.text,layout:this.detectLayout(r),textFrameCount:r.length}}parseTextFrames(e){let t=e.split(/\n\n+/).filter(o=>o.trim()),r=[];return t.forEach((o,n)=>{let s=n===0?"title":n===1?"body":"other";r.push({index:n,type:s,text:o.trim(),bounds:{x:0,y:0,width:0,height:0}});}),r}detectLayout(e){return e.length===0?"blank":e.length===1&&e[0]?.type==="title"?"title":e.length>=2?"titleContent":"blank"}applySlideLayout(e){let r={blank:0,title:1,titleContent:2,twoColumn:3}[e]??0,o=JSON.stringify({WhatLayout:{type:"long",value:r}});this.lok.postUnoCommand(this.docPtr,".uno:AssignLayout",o);}};var R=class extends _{isImportedPdf=false;getDocumentType(){return "draw"}setImportedPdf(e){this.isImportedPdf=e;}getStructure(e){try{let t=this.lok.documentGetParts(this.docPtr),r=[];for(let n=0;n<t;n++){let s=this.getPageInfoInternal(n);r.push(s);}let o={type:"draw",pages:r,pageCount:t,isImportedPdf:this.isImportedPdf};return this.createResult(o)}catch(t){return this.createErrorResult(`Failed to get structure: ${String(t)}`)}}getPage(e){try{let t=this.lok.documentGetParts(this.docPtr);if(e<0||e>=t)return this.createErrorResult(`Invalid page index: ${e}. Valid range: 0-${t-1}`,"Use getStructure() to see available pages");this.lok.documentSetPart(this.docPtr,e);let r=this.lok.documentGetDocumentSize(this.docPtr),o=this.getShapesOnPage(),n={index:e,shapes:o,size:{width:r.width,height:r.height}};return this.createResult(n)}catch(t){return this.createErrorResult(`Failed to get page: ${String(t)}`)}}getPageCount(){try{let e=this.lok.documentGetParts(this.docPtr);return this.createResult(e)}catch(e){return this.createErrorResult(`Failed to get page count: ${String(e)}`)}}addPage(e){try{let t=this.lok.documentGetParts(this.docPtr);e?.afterPage!==void 0?this.lok.documentSetPart(this.docPtr,e.afterPage):this.lok.documentSetPart(this.docPtr,t-1),this.lok.postUnoCommand(this.docPtr,".uno:InsertPage");let r=e?.afterPage!==void 0?e.afterPage+1:t;return this.createResult({index:r})}catch(t){return this.createErrorResult(`Failed to add page: ${String(t)}`)}}deletePage(e){try{let t=this.lok.documentGetParts(this.docPtr);return t<=1?this.createErrorResult("Cannot delete the last page","A drawing document must have at least one page"):e<0||e>=t?this.createErrorResult(`Invalid page index: ${e}`,`Valid range: 0-${t-1}`):(this.lok.documentSetPart(this.docPtr,e),this.lok.postUnoCommand(this.docPtr,".uno:DeletePage"),this.createResult(void 0))}catch(t){return this.createErrorResult(`Failed to delete page: ${String(t)}`)}}duplicatePage(e){try{let t=this.lok.documentGetParts(this.docPtr);return e<0||e>=t?this.createErrorResult(`Invalid page index: ${e}`,`Valid range: 0-${t-1}`):(this.lok.documentSetPart(this.docPtr,e),this.lok.postUnoCommand(this.docPtr,".uno:DuplicatePage"),this.createResult({newIndex:e+1}))}catch(t){return this.createErrorResult(`Failed to duplicate page: ${String(t)}`)}}addShape(e,t,r,o){try{let n=this.lok.documentGetParts(this.docPtr);if(e<0||e>=n)return this.createErrorResult(`Invalid page index: ${e}`);this.lok.documentSetPart(this.docPtr,e);let s=this.getShapeCommand(t),i=JSON.stringify({X:{type:"long",value:r.x},Y:{type:"long",value:r.y},Width:{type:"long",value:r.width},Height:{type:"long",value:r.height}});if(this.lok.postUnoCommand(this.docPtr,s,i),o?.text){let a=JSON.stringify({Text:{type:"string",value:o.text}});this.lok.postUnoCommand(this.docPtr,".uno:InsertText",a);}if(o?.fillColor){let a=JSON.stringify({FillColor:{type:"long",value:this.hexToNumber(o.fillColor)}});this.lok.postUnoCommand(this.docPtr,".uno:FillColor",a);}if(o?.lineColor){let a=JSON.stringify({LineColor:{type:"long",value:this.hexToNumber(o.lineColor)}});this.lok.postUnoCommand(this.docPtr,".uno:XLineColor",a);}return this.createResult({shapeIndex:0})}catch(n){return this.createErrorResult(`Failed to add shape: ${String(n)}`)}}addLine(e,t,r,o){try{let n=this.lok.documentGetParts(this.docPtr);if(e<0||e>=n)return this.createErrorResult(`Invalid page index: ${e}`);this.lok.documentSetPart(this.docPtr,e);let s=JSON.stringify({StartX:{type:"long",value:t.x},StartY:{type:"long",value:t.y},EndX:{type:"long",value:r.x},EndY:{type:"long",value:r.y}});if(this.lok.postUnoCommand(this.docPtr,".uno:Line",s),o?.lineColor){let i=JSON.stringify({LineColor:{type:"long",value:this.hexToNumber(o.lineColor)}});this.lok.postUnoCommand(this.docPtr,".uno:XLineColor",i);}if(o?.lineWidth){let i=JSON.stringify({LineWidth:{type:"long",value:o.lineWidth}});this.lok.postUnoCommand(this.docPtr,".uno:LineWidth",i);}return this.createResult({shapeIndex:0})}catch(n){return this.createErrorResult(`Failed to add line: ${String(n)}`)}}deleteShape(e,t){try{return this.lok.documentSetPart(this.docPtr,e),this.selectShape(t),this.lok.postUnoCommand(this.docPtr,".uno:Delete"),this.createResult(void 0)}catch(r){return this.createErrorResult(`Failed to delete shape: ${String(r)}`)}}setShapeText(e,t,r){try{this.lok.documentSetPart(this.docPtr,e),this.selectShape(t),this.lok.postUnoCommand(this.docPtr,".uno:EnterGroup"),this.lok.postUnoCommand(this.docPtr,".uno:SelectAll");let o=JSON.stringify({Text:{type:"string",value:r}});return this.lok.postUnoCommand(this.docPtr,".uno:InsertText",o),this.lok.postUnoCommand(this.docPtr,".uno:LeaveGroup"),this.createResult(void 0)}catch(o){return this.createErrorResult(`Failed to set shape text: ${String(o)}`)}}moveShape(e,t,r){try{this.lok.documentSetPart(this.docPtr,e),this.selectShape(t);let o=JSON.stringify({X:{type:"long",value:r.x},Y:{type:"long",value:r.y}});return this.lok.postUnoCommand(this.docPtr,".uno:SetObjectPosition",o),this.createResult(void 0)}catch(o){return this.createErrorResult(`Failed to move shape: ${String(o)}`)}}resizeShape(e,t,r){try{this.lok.documentSetPart(this.docPtr,e),this.selectShape(t);let o=JSON.stringify({Width:{type:"long",value:r.width},Height:{type:"long",value:r.height}});return this.lok.postUnoCommand(this.docPtr,".uno:Size",o),this.createResult(void 0)}catch(o){return this.createErrorResult(`Failed to resize shape: ${String(o)}`)}}getPageInfoInternal(e){this.lok.documentSetPart(this.docPtr,e);let t=this.lok.documentGetDocumentSize(this.docPtr),r=this.getShapesOnPage();return {index:e,shapeCount:r.length,size:{width:t.width,height:t.height}}}getShapesOnPage(){let e=this.lok.getAllText(this.docPtr)||"";return e.trim()?[{index:0,type:"text",text:e,bounds:{x:0,y:0,width:0,height:0}}]:[]}selectShape(e){let t=JSON.stringify({Index:{type:"long",value:e}});this.lok.postUnoCommand(this.docPtr,".uno:SelectObject",t);}getShapeCommand(e){return {rectangle:".uno:Rect",ellipse:".uno:Ellipse",line:".uno:Line",text:".uno:Text",image:".uno:InsertGraphic",group:".uno:FormatGroup",other:".uno:Rect"}[e]}hexToNumber(e){return parseInt(e.replace("#",""),16)}};var $=0,V=1,z=2,G=3;function x(c,e,t){let r=c.documentGetDocumentType(e);switch(r){case $:return new C(c,e,t);case V:return new O(c,e,t);case z:return new v(c,e,t);case G:return new R(c,e,t);default:throw new Error(`Unsupported document type: ${r}`)}}function H(c){return c.getDocumentType()==="writer"}function J(c){return c.getDocumentType()==="calc"}function j(c){return c.getDocumentType()==="impress"}function Y(c){return c.getDocumentType()==="draw"}function X(c){return {0:"INVALIDATE_TILES",1:"INVALIDATE_VISIBLE_CURSOR",2:"TEXT_SELECTION",3:"TEXT_SELECTION_START",4:"TEXT_SELECTION_END",5:"CURSOR_VISIBLE",6:"GRAPHIC_SELECTION",7:"HYPERLINK_CLICKED",8:"STATE_CHANGED",9:"STATUS_INDICATOR_START",10:"STATUS_INDICATOR_SET_VALUE",11:"STATUS_INDICATOR_FINISH",12:"SEARCH_NOT_FOUND",13:"DOCUMENT_SIZE_CHANGED",14:"SET_PART",15:"SEARCH_RESULT_SELECTION",16:"UNO_COMMAND_RESULT",17:"CELL_CURSOR",18:"MOUSE_POINTER",19:"CELL_FORMULA",20:"DOCUMENT_PASSWORD",21:"DOCUMENT_PASSWORD_TO_MODIFY",22:"CONTEXT_MENU",23:"INVALIDATE_VIEW_CURSOR",24:"TEXT_VIEW_SELECTION",25:"CELL_VIEW_CURSOR",26:"GRAPHIC_VIEW_SELECTION",27:"VIEW_CURSOR_VISIBLE",28:"VIEW_LOCK",29:"REDLINE_TABLE_SIZE_CHANGED",30:"REDLINE_TABLE_ENTRY_MODIFIED",31:"COMMENT",32:"INVALIDATE_HEADER",33:"CELL_ADDRESS"}[c]||`UNKNOWN(${c})`}var A={nSize:0,destroy:4,documentLoad:8,getError:12,documentLoadWithOptions:16,freeError:20},M={nSize:0,destroy:4,saveAs:8},Z=new TextEncoder,K=new TextDecoder,k=class{module;lokPtr=0;verbose;useShims;constructor(e,t=false){this.module=e,this.verbose=t,this.useShims=typeof this.module._lok_documentLoad=="function",this.useShims?this.log("Using direct LOK shim exports"):this.log("Using vtable traversal (shims not available)");}log(...e){this.verbose&&console.log("[LOK]",...e);}get HEAPU8(){return this.module.HEAPU8}get HEAPU32(){return this.module.HEAPU32}get HEAP32(){return this.module.HEAP32}allocString(e){let t=Z.encode(e+"\0"),r=this.module._malloc(t.length);return this.HEAPU8.set(t,r),r}readString(e){if(e===0)return null;let t=this.HEAPU8,r=e;for(;t[r]!==0;)r++;let o=t.slice(e,r);return K.decode(o)}readPtr(e){return this.HEAPU32[e>>2]||0}getFunc(e){return this.module.wasmTable.get(e)}initialize(e="/instdir/program"){this.log("Initializing with path:",e);let t=this.allocString(e);try{let r=this.module._libreofficekit_hook;if(typeof r!="function")throw new Error("libreofficekit_hook export not found on module");if(this.lokPtr=r(t),this.lokPtr===0)throw new Error("Failed to initialize LibreOfficeKit");this.log("LOK initialized, ptr:",this.lokPtr);}finally{this.module._free(t);}}getError(){if(this.lokPtr===0)return null;if(this.useShims&&this.module._lok_getError){let n=this.module._lok_getError(this.lokPtr);return this.readString(n)}let e=this.readPtr(this.lokPtr),t=this.readPtr(e+A.getError);if(t===0)return null;let o=this.getFunc(t)(this.lokPtr);return this.readString(o)}getVersionInfo(){return "LibreOffice WASM"}toFileUrl(e){return e.startsWith("file://")?e:"file://"+(e.startsWith("/")?e:"/"+e)}documentLoad(e){if(this.lokPtr===0)throw new Error("LOK not initialized");let t=this.toFileUrl(e);this.log("Loading document:",e,"->",t);let r=this.allocString(t);try{let o=Date.now(),n;if(this.useShims&&this.module._lok_documentLoad)n=this.module._lok_documentLoad(this.lokPtr,r);else {let s=this.readPtr(this.lokPtr),i=this.readPtr(s+A.documentLoad);n=this.getFunc(i)(this.lokPtr,r);}if(this.log("Document loaded in",Date.now()-o,"ms, ptr:",n),n===0){let s=this.getError();throw new Error(`Failed to load document: ${s||"unknown error"}`)}return n}finally{this.module._free(r);}}documentLoadWithOptions(e,t){if(this.lokPtr===0)throw new Error("LOK not initialized");let r=this.toFileUrl(e);this.log("Loading document with options:",e,"->",r,t);let o=this.allocString(r),n=this.allocString(t);try{let s;if(this.useShims&&this.module._lok_documentLoadWithOptions)s=this.module._lok_documentLoadWithOptions(this.lokPtr,o,n);else {let i=this.readPtr(this.lokPtr),a=this.readPtr(i+A.documentLoadWithOptions);if(a===0)return this.documentLoad(e);s=this.getFunc(a)(this.lokPtr,o,n);}if(s===0){let i=this.getError();throw new Error(`Failed to load document: ${i||"unknown error"}`)}return this.log("Document loaded, ptr:",s),s}finally{this.module._free(o),this.module._free(n);}}documentSaveAs(e,t,r,o=""){if(e===0)throw new Error("Invalid document pointer");let n=this.toFileUrl(t);this.log("Saving document to:",t,"->",n,"format:",r);let s=this.allocString(n),i=this.allocString(r),a=this.allocString(o);try{let l;if(this.useShims&&this.module._lok_documentSaveAs)l=this.module._lok_documentSaveAs(e,s,i,a);else {let u=this.readPtr(e),m=this.readPtr(u+M.saveAs);l=this.getFunc(m)(e,s,i,a);}if(this.log("Save result:",l),l===0)throw new Error("Failed to save document")}finally{this.module._free(s),this.module._free(i),this.module._free(a);}}documentDestroy(e){if(e===0)return;if(this.useShims&&this.module._lok_documentDestroy){this.module._lok_documentDestroy(e),this.log("Document destroyed (via shim)");return}let t=this.readPtr(e),r=this.readPtr(t+M.destroy);r!==0&&(this.getFunc(r)(e),this.log("Document destroyed (via vtable)"));}destroy(){if(this.lokPtr!==0){try{if(this.useShims&&this.module._lok_destroy)this.module._lok_destroy(this.lokPtr),this.log("LOK destroyed (via shim)");else {let e=this.readPtr(this.lokPtr),t=this.readPtr(e+A.destroy);t!==0&&(this.getFunc(t)(this.lokPtr),this.log("LOK destroyed (via vtable)"));}}catch(e){this.log("LOK destroy error (ignored):",e);}this.lokPtr=0;}}isInitialized(){return this.lokPtr!==0}isUsingShims(){return this.useShims}documentGetParts(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetParts?this.module._lok_documentGetParts(e):(this.log("documentGetParts: shim not available"),0)}documentGetPart(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetPart?this.module._lok_documentGetPart(e):(this.log("documentGetPart: shim not available"),0)}documentSetPart(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetPart){this.module._lok_documentSetPart(e,t);return}this.log("documentSetPart: shim not available");}documentGetDocumentType(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetDocumentType?this.module._lok_documentGetDocumentType(e):(this.log("documentGetDocumentType: shim not available"),0)}documentGetDocumentSize(e){if(this.log(`documentGetDocumentSize called with docPtr: ${e}`),e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetDocumentSize){let t=this.module._malloc(8);try{this.module._lok_documentGetDocumentSize(e,t,t+4);let r=this.HEAP32[t>>2]??0,o=this.HEAP32[t+4>>2]??0;return this.log(`documentGetDocumentSize: ${r}x${o} twips`),{width:r,height:o}}finally{this.module._free(t);}}return this.log("documentGetDocumentSize: shim not available"),{width:0,height:0}}documentInitializeForRendering(e,t=""){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentInitializeForRendering){let r=this.allocString(t);try{this.module._lok_documentInitializeForRendering(e,r);}finally{this.module._free(r);}return}this.log("documentInitializeForRendering: shim not available");}documentPaintTile(e,t,r,o,n,s,i){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentPaintTile){let a=t*r*4,l=this.module._malloc(a);if(l===0)throw new Error(`Failed to allocate ${a} bytes for tile buffer`);try{this.module._lok_documentPaintTile(e,l,t,r,o,n,s,i);let u=new Uint8Array(a);return u.set(this.HEAPU8.subarray(l,l+a)),u}finally{this.module._free(l);}}return this.log("documentPaintTile: shim not available"),new Uint8Array(0)}documentGetTileMode(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetTileMode?this.module._lok_documentGetTileMode(e):(this.log("documentGetTileMode: shim not available"),0)}renderPage(e,t,r,o=0,n=false){this.documentInitializeForRendering(e);let s=this.documentGetDocumentType(e);if(s===2||s===3){console.log(`[LOK] Setting part to ${t} for presentation/drawing`),this.documentSetPart(e,t);let b=this.documentGetPart(e);console.log(`[LOK] Current part after setPart: ${b}`),n||(this.setEditMode(e,0),console.log("[LOK] Set edit mode to 0 (view mode) for presentation rendering"));}let i=this.documentGetDocumentSize(e);if(this.log("Document size (twips):",i),i.width===0||i.height===0)throw new Error("Failed to get document size");let a=0,l=0,u=i.width,m=i.height;if(s===0||s===1){let b=this.getPartPageRectangles(e);if(b){let E=this.parsePageRectangles(b)[t];E&&(a=E.x,l=E.y,u=E.width,m=E.height,this.log(`Page ${t} rectangle:`,E));}}let f=m/u,h=r,p=o>0?o:Math.round(r*f);console.log(`[LOK] Calling paintTile: ${h}x${p} from tile pos (${a}, ${l}) size (${u}x${m})`);let g=this.documentPaintTile(e,h,p,a,l,u,m);return console.log(`[LOK] paintTile returned ${g.length} bytes`),{data:g,width:h,height:p}}renderPageFullQuality(e,t,r=150,o,n=false){this.documentInitializeForRendering(e);let s=this.documentGetDocumentType(e);(s===2||s===3)&&(this.log(`Setting part to ${t} for presentation/drawing`),this.documentSetPart(e,t),n||(this.setEditMode(e,0),this.log("Set edit mode to 0 (view mode) for presentation rendering")));let i=this.documentGetDocumentSize(e);if(this.log("Document size (twips):",i),i.width===0||i.height===0)throw new Error("Failed to get document size");let a=0,l=0,u=i.width,m=i.height;if(s===0||s===1){let S=this.getPartPageRectangles(e);if(S){let P=this.parsePageRectangles(S)[t];P&&(a=P.x,l=P.y,u=P.width,m=P.height,this.log(`Page ${t} rectangle:`,P));}}let f=1440,h=Math.round(u*r/f),p=Math.round(m*r/f),g=r;if(o&&(h>o||p>o)){let S=o/Math.max(h,p);h=Math.round(h*S),p=Math.round(p*S),g=Math.round(r*S),this.log(`Capped dimensions to ${h}x${p} (effective DPI: ${g})`);}console.log(`[LOK] renderPageFullQuality: ${h}x${p} at ${g} DPI from tile (${a}, ${l}) size (${u}x${m}) twips`);let b=this.documentPaintTile(e,h,p,a,l,u,m);return console.log(`[LOK] renderPageFullQuality returned ${b.length} bytes`),{data:b,width:h,height:p,dpi:g}}getTextSelection(e,t="text/plain;charset=utf-8"){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetTextSelection){let r=this.allocString(t),o=this.module._malloc(4);try{let n=this.module._lok_documentGetTextSelection(e,r,o);if(n===0)return null;let s=this.readString(n);return this.module._free(n),s}finally{this.module._free(r),this.module._free(o);}}return this.log("getTextSelection: shim not available"),null}setTextSelection(e,t,r,o){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetTextSelection){this.module._lok_documentSetTextSelection(e,t,r,o);return}this.log("setTextSelection: shim not available");}getSelectionType(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetSelectionType?this.module._lok_documentGetSelectionType(e):(this.log("getSelectionType: shim not available"),0)}resetSelection(e){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentResetSelection){this.module._lok_documentResetSelection(e);return}this.log("resetSelection: shim not available");}postMouseEvent(e,t,r,o,n=1,s=1,i=0){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentPostMouseEvent){this.module._lok_documentPostMouseEvent(e,t,r,o,n,s,i);return}this.log("postMouseEvent: shim not available");}postKeyEvent(e,t,r,o){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentPostKeyEvent){this.module._lok_documentPostKeyEvent(e,t,r,o);return}this.log("postKeyEvent: shim not available");}postUnoCommand(e,t,r="{}",o=false){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentPostUnoCommand){let n=this.allocString(t),s=this.allocString(r);try{this.module._lok_documentPostUnoCommand(e,n,s,o?1:0);}finally{this.module._free(n),this.module._free(s);}return}this.log("postUnoCommand: shim not available");}getCommandValues(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetCommandValues){let r=this.allocString(t);try{let o=this.module._lok_documentGetCommandValues(e,r);if(o===0)return null;let n=this.readString(o);return this.module._free(o),n}finally{this.module._free(r);}}return this.log("getCommandValues: shim not available"),null}getPartPageRectangles(e){if(this.log(`getPartPageRectangles called with docPtr: ${e}`),e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetPartPageRectangles){this.log("getPartPageRectangles: using shim");let t=this.module._lok_documentGetPartPageRectangles(e);if(this.log(`getPartPageRectangles: resultPtr=${t}`),t===0)return null;let r=this.readString(t);return this.log(`getPartPageRectangles: result="${r?.slice(0,100)}..."`),this.module._free(t),r}return this.log("getPartPageRectangles: shim not available"),null}getPartInfo(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetPartInfo){let r=this.module._lok_documentGetPartInfo(e,t);if(r===0)return null;let o=this.readString(r);return this.module._free(r),o}return this.log("getPartInfo: shim not available"),null}getPartName(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetPartName){let r=this.module._lok_documentGetPartName(e,t);if(r===0)return null;let o=this.readString(r);return this.module._free(r),o}return this.log("getPartName: shim not available"),null}paste(e,t,r){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentPaste){let o=this.allocString(t),n,s;if(typeof r=="string"){let i=new TextEncoder().encode(r);s=i.length,n=this.module._malloc(s),this.HEAPU8.set(i,n);}else s=r.length,n=this.module._malloc(s),this.HEAPU8.set(r,n);try{return this.module._lok_documentPaste(e,o,n,s)!==0}finally{this.module._free(o),this.module._free(n);}}return this.log("paste: shim not available"),false}setClientZoom(e,t,r,o,n){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetClientZoom){this.module._lok_documentSetClientZoom(e,t,r,o,n);return}this.log("setClientZoom: shim not available");}setClientVisibleArea(e,t,r,o,n){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetClientVisibleArea){this.module._lok_documentSetClientVisibleArea(e,t,r,o,n);return}this.log("setClientVisibleArea: shim not available");}getA11yFocusedParagraph(e){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetA11yFocusedParagraph){let t=this.module._lok_documentGetA11yFocusedParagraph(e);if(t===0)return null;let r=this.readString(t);return this.module._free(t),r}return this.log("getA11yFocusedParagraph: shim not available"),null}getA11yCaretPosition(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetA11yCaretPosition?this.module._lok_documentGetA11yCaretPosition(e):(this.log("getA11yCaretPosition: shim not available"),-1)}setAccessibilityState(e,t,r){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetAccessibilityState){this.module._lok_documentSetAccessibilityState(e,t,r?1:0);return}this.log("setAccessibilityState: shim not available");}getDataArea(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentGetDataArea){let r=this.module._malloc(8),o=this.module._malloc(8);try{this.module._lok_documentGetDataArea(e,t,r,o);let n=this.HEAP32[r>>2]??0,s=this.HEAP32[o>>2]??0;return {col:n,row:s}}finally{this.module._free(r),this.module._free(o);}}return this.log("getDataArea: shim not available"),{col:0,row:0}}getEditMode(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetEditMode?this.module._lok_documentGetEditMode(e):(this.log("getEditMode: shim not available"),0)}setEditMode(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetEditMode){this.log(`setEditMode: setting mode to ${t}`),this.module._lok_documentSetEditMode(e,t);return}this.log("setEditMode: shim not available");}createView(e){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentCreateView){let t=this.module._lok_documentCreateView(e);return this.log(`createView: created view ${t}`),t}return this.log("createView: shim not available"),-1}createViewWithOptions(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentCreateViewWithOptions){let r=this.allocString(t);try{let o=this.module._lok_documentCreateViewWithOptions(e,r);return this.log(`createViewWithOptions: created view ${o}`),o}finally{this.module._free(r);}}return this.log("createViewWithOptions: shim not available"),-1}destroyView(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentDestroyView){this.log(`destroyView: destroying view ${t}`),this.module._lok_documentDestroyView(e,t);return}this.log("destroyView: shim not available");}setView(e,t){if(e===0)throw new Error("Invalid document pointer");if(this.useShims&&this.module._lok_documentSetView){this.log(`setView: setting active view to ${t}`),this.module._lok_documentSetView(e,t);return}this.log("setView: shim not available");}getView(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetView?this.module._lok_documentGetView(e):(this.log("getView: shim not available"),-1)}getViewsCount(e){if(e===0)throw new Error("Invalid document pointer");return this.useShims&&this.module._lok_documentGetViewsCount?this.module._lok_documentGetViewsCount(e):(this.log("getViewsCount: shim not available"),0)}enableSyncEvents(){this.useShims&&this.module._lok_enableSyncEvents?(this.module._lok_enableSyncEvents(),this.log("enableSyncEvents: Unipoll mode enabled")):this.log("enableSyncEvents: shim not available");}disableSyncEvents(){this.useShims&&this.module._lok_disableSyncEvents?(this.module._lok_disableSyncEvents(),this.log("disableSyncEvents: Unipoll mode disabled")):this.log("disableSyncEvents: shim not available");}registerCallback(e){if(e===0)throw new Error("Invalid document pointer");this.useShims&&this.module._lok_documentRegisterCallback?(this.module._lok_documentRegisterCallback(e),this.log("registerCallback: callback registered")):this.log("registerCallback: shim not available");}unregisterCallback(e){if(e===0)throw new Error("Invalid document pointer");this.useShims&&this.module._lok_documentUnregisterCallback?(this.module._lok_documentUnregisterCallback(e),this.log("unregisterCallback: callback unregistered")):this.log("unregisterCallback: shim not available");}hasCallbackEvents(){return this.useShims&&this.module._lok_hasCallbackEvents?this.module._lok_hasCallbackEvents()!==0:false}getCallbackEventCount(){return this.useShims&&this.module._lok_getCallbackEventCount?this.module._lok_getCallbackEventCount():0}pollCallback(){if(!this.useShims||!this.module._lok_pollCallback)return null;let e=4096,t=this.module._malloc(e),r=this.module._malloc(4);try{let o=this.module._lok_pollCallback(t,e,r);if(o===-1)return null;let n=this.module.HEAP32[r>>2]??0,s="";if(n>0){let i=Math.min(n,e-1),a=this.module.HEAPU8.slice(t,t+i);s=K.decode(a);}return {type:o,typeName:X(o),payload:s}}finally{this.module._free(t),this.module._free(r);}}pollAllCallbacks(){let e=[],t=this.pollCallback();for(;t!==null;)e.push(t),t=this.pollCallback();return e}clearCallbackQueue(){this.useShims&&this.module._lok_clearCallbackQueue&&(this.module._lok_clearCallbackQueue(),this.log("clearCallbackQueue: queue cleared"));}flushCallbacks(e){if(e===0)throw new Error("Invalid document pointer");let t=!!this.module._lok_flushCallbacks;this.log(`flushCallbacks: useShims=${this.useShims}, _lok_flushCallbacks exists=${t}`),this.useShims&&this.module._lok_flushCallbacks?(this.module._lok_flushCallbacks(e),this.log("flushCallbacks: callbacks flushed")):this.log("flushCallbacks: shim not available");}pollStateChanges(){let e=new Map,t=this.pollAllCallbacks();for(let r of t)if(r.type===8){let o=r.payload.indexOf("=");if(o!==-1){let n=r.payload.substring(0,o),s=r.payload.substring(o+1);e.set(n,s);}else e.set(r.payload,"");}return e}clickAndGetText(e,t,r){return this.postMouseEvent(e,0,t,r,1,1,0),this.postMouseEvent(e,1,t,r,1,1,0),this.getTextSelection(e,"text/plain;charset=utf-8")}doubleClickAndGetWord(e,t,r){return this.postMouseEvent(e,0,t,r,2,1,0),this.postMouseEvent(e,1,t,r,2,1,0),this.getTextSelection(e,"text/plain;charset=utf-8")}selectAll(e){this.postUnoCommand(e,".uno:SelectAll");}getAllText(e){this.log(`getAllText called with docPtr: ${e}`),this.selectAll(e);let t=this.getTextSelection(e,"text/plain;charset=utf-8");return this.log(`getAllText: text="${t?.slice(0,100)}..."`),this.resetSelection(e),t}parsePageRectangles(e){return e?e.split(";").filter(t=>t.trim()).map(t=>{let r=t.split(",").map(Number);return {x:r[0]??0,y:r[1]??0,width:r[2]??0,height:r[3]??0}}):[]}};var I=class{module=null;_lokInstance=0;lokBindings=null;initialized=false;initializing=false;options;constructor(e={}){let t=w();this.options={verbose:false,...t,...e};}async initialize(){if(!this.initialized){if(this.initializing){for(;this.initializing;)await new Promise(e=>setTimeout(e,100));return}this.initializing=true,this.emitProgress("loading",0,"Loading LibreOffice WASM...");try{this.module=await this.loadModule(),this.emitProgress("initializing",50,"Initializing..."),this.setupFileSystem(),this.initLOK(),this.initialized=!0,this.emitProgress("complete",100,"Ready"),this.options.onReady?.();}catch(e){let t=e instanceof d?e:new d("WASM_NOT_INITIALIZED",String(e));throw this.options.onError?.(t),t}finally{this.initializing=false;}}}async loadModule(){let{sofficeJs:e,sofficeWasm:t,sofficeData:r,sofficeWorkerJs:o}=this.options,n=window;return new Promise((s,i)=>{n.Module={locateFile:l=>l.endsWith(".wasm")?t:l.endsWith(".data")?r:l.endsWith(".worker.js")||l.endsWith(".worker.cjs")?o:`${e.substring(0,e.lastIndexOf("/")+1)}${l}`,print:this.options.verbose?console.log:()=>{},printErr:this.options.verbose?console.error:()=>{},onRuntimeInitialized:()=>{this.options.verbose&&console.log("[Browser] WASM runtime initialized"),s(n.Module);},onAbort:l=>{i(new d("WASM_NOT_INITIALIZED",`WASM abort: ${l}`));}};let a=document.createElement("script");a.src=e,a.onerror=()=>i(new Error(`Failed to load ${e}`)),document.head.appendChild(a),setTimeout(()=>{i(new d("WASM_NOT_INITIALIZED","WASM load timeout"));},6e4);})}setupFileSystem(){if(!this.module?.FS)throw new d("WASM_NOT_INITIALIZED","No FS");let e=this.module.FS;try{e.mkdir("/tmp");}catch{}try{e.mkdir("/tmp/input");}catch{}try{e.mkdir("/tmp/output");}catch{}}initLOK(){if(!this.module)throw new d("WASM_NOT_INITIALIZED","No module");this.lokBindings=new k(this.module,this.options.verbose),this.lokBindings.initialize("/instdir/program"),this._lokInstance=this.lokBindings.lokPtr??1;}async convert(e,t,r="document"){if(!this.initialized||!this.module||!this.lokBindings)throw new d("WASM_NOT_INITIALIZED","Not initialized");let o=Date.now(),n=e instanceof Uint8Array?e:new Uint8Array(e);if(n.length===0)throw new d("INVALID_INPUT","Empty document");let s=this.getExt(r)||t.inputFormat||"docx",i=t.outputFormat;if(!y[i])throw new d("UNSUPPORTED_FORMAT",`Unsupported: ${i}`);let a=`/tmp/input/doc.${s}`,l=`/tmp/output/doc.${i}`,u=0;try{if(this.module.FS.writeFile(a,n),this.emitProgress("converting",30,"Loading document..."),t.password?u=this.lokBindings.documentLoadWithOptions(a,`,Password=${t.password}`):u=this.lokBindings.documentLoad(a),u===0){let g=this.lokBindings.getError();throw new d("LOAD_FAILED",g||"Failed to load document")}this.emitProgress("converting",50,"Converting...");let m=N[i],f=U[i]||"";if(i==="pdf"&&t.pdf){let g=[];if(t.pdf.pdfaLevel){let b={"PDF/A-1b":1,"PDF/A-2b":2,"PDF/A-3b":3};g.push(`SelectPdfVersion=${b[t.pdf.pdfaLevel]||0}`);}t.pdf.quality!==void 0&&g.push(`Quality=${t.pdf.quality}`),g.length>0&&(f=g.join(","));}this.emitProgress("converting",70,"Saving..."),this.lokBindings.documentSaveAs(u,l,m,f),this.emitProgress("converting",90,"Reading output...");let h=this.module.FS.readFile(l);if(h.length===0)throw new d("CONVERSION_FAILED","Empty output");let p=r.includes(".")?r.substring(0,r.lastIndexOf(".")):r;return this.emitProgress("complete",100,"Done"),{data:h,mimeType:T[i],filename:`${p}.${i}`,duration:Date.now()-o}}finally{if(u!==0)try{this.lokBindings.documentDestroy(u);}catch{}try{this.module.FS.unlink(a);}catch{}try{this.module.FS.unlink(l);}catch{}}}async openDocument(e,t,r){if(!this.initialized||!this.lokBindings||!this.module)throw new d("WASM_NOT_INITIALIZED","Not initialized");let o=e instanceof ArrayBuffer?new Uint8Array(e):e,n=this.getExt(t)||"docx",s=`/tmp/input/edit_${Date.now()}.${n}`;this.module.FS.writeFile(s,o);let i;if(r?.password?i=this.lokBindings.documentLoadWithOptions(s,`,Password=${r.password}`):i=this.lokBindings.documentLoad(s),i===0){let l=this.lokBindings.getError();throw new d("LOAD_FAILED",l||"Failed to load document")}let a=x(this.lokBindings,i,r);return a.setInputPath(s),a}getLokBindings(){if(!this.lokBindings)throw new d("WASM_NOT_INITIALIZED","Not initialized");return this.lokBindings}async convertFile(e,t){let r=await e.arrayBuffer();return this.convert(new Uint8Array(r),t,e.name)}async convertFromUrl(e,t){let r=await fetch(e);if(!r.ok)throw new Error(`Fetch failed: ${r.statusText}`);let o=await r.arrayBuffer(),n=e.split("/").pop()||"document";return this.convert(new Uint8Array(o),t,n)}download(e,t){let r=new Uint8Array(e.data).buffer,o=new Blob([r],{type:e.mimeType}),n=URL.createObjectURL(o),s=document.createElement("a");s.href=n,s.download=t||e.filename,s.click(),setTimeout(()=>URL.revokeObjectURL(n),1e3);}createBlobUrl(e){let t=new Uint8Array(e.data).buffer,r=new Blob([t],{type:e.mimeType});return URL.createObjectURL(r)}preview(e){return window.open(this.createBlobUrl(e),"_blank")}async destroy(){if(this.lokBindings){try{this.lokBindings.destroy();}catch{}this.lokBindings=null;}this.module=null,this._lokInstance=0,this.initialized=false;}isReady(){return this.initialized&&this._lokInstance>=0}static getSupportedOutputFormats(){return Object.keys(y)}getExt(e){let t=e.split(".");return t.length>1&&t.pop()?.toLowerCase()||null}emitProgress(e,t,r){this.options.onProgress?.({phase:e,percent:t,message:r});}},W=class{worker=null;initialized=false;initializing=false;messageId=0;pendingRequests=new Map;options;constructor(e={}){let t=w();this.options={verbose:false,browserWorkerJs:"/dist/browser.worker.global.js",...t,...e};}async initialize(){if(!this.initialized){if(this.initializing){for(;this.initializing;)await new Promise(e=>setTimeout(e,100));return}this.initializing=true,this.emitProgress("loading",0,"Starting worker...");try{this.worker=new Worker(this.options.browserWorkerJs),this.worker.onmessage=e=>this.handleWorkerMessage(e),this.worker.onerror=e=>{console.error("[WorkerConverter] Worker error:",e),this.options.onError?.(new d("WASM_NOT_INITIALIZED",e.message));},await new Promise((e,t)=>{let r=setTimeout(()=>t(new Error("Worker load timeout")),1e4),o=n=>{n.data.type==="loaded"&&(clearTimeout(r),this.worker?.removeEventListener("message",o),e());};this.worker.addEventListener("message",o);}),await this.sendMessage("init",{sofficeJs:this.options.sofficeJs,sofficeWasm:this.options.sofficeWasm,sofficeData:this.options.sofficeData,sofficeWorkerJs:this.options.sofficeWorkerJs,enableProgressTracking:this.options.enableProgressTracking,verbose:this.options.verbose}),this.initialized=!0,this.emitProgress("complete",100,"Ready"),this.options.onReady?.();}catch(e){let t=e instanceof d?e:new d("WASM_NOT_INITIALIZED",String(e));throw this.options.onError?.(t),t}finally{this.initializing=false;}}}handleWorkerMessage(e){let t=e.data;if(t.type==="progress"){let o=t.progress;o&&this.emitProgress("converting",o.percent,o.message);return}let r=this.pendingRequests.get(t.id);r&&(this.pendingRequests.delete(t.id),t.type==="error"?r.reject(new d("CONVERSION_FAILED",t.error??"Unknown error")):t.type==="result"?r.resolve(t.data):t.type==="ready"?r.resolve(void 0):t.type==="pageCount"?r.resolve(t.pageCount):t.type==="previews"?r.resolve(t.previews):t.type==="singlePagePreview"||t.type==="fullQualityPagePreview"?r.resolve(t.preview):t.type==="documentInfo"?r.resolve(t.documentInfo):t.type==="lokInfo"?r.resolve(t.lokInfo):t.type==="editResult"?r.resolve(t.editResult):t.type==="pageRectangles"?r.resolve(t.pageRectangles):t.type==="testLokOperations"?r.resolve(t.testLokOperationsResult):t.type==="editorSession"?r.resolve(t.editorSession):t.type==="editorOperationResult"?r.resolve(t.editorOperationResult):t.type==="documentClosed"&&r.resolve(t.data));}sendMessage(e,t={}){return new Promise((r,o)=>{if(!this.worker){o(new Error("Worker not initialized"));return}let n=++this.messageId;if(this.pendingRequests.set(n,{resolve:r,reject:o}),t.inputData instanceof Uint8Array){let s=new Uint8Array(t.inputData.length);s.set(t.inputData);let i={type:e,id:n,...t,inputData:s};this.worker.postMessage(i,[s.buffer]);}else {let s={type:e,id:n,...t};this.worker.postMessage(s);}})}async convert(e,t,r="document"){if(!this.initialized||!this.worker)throw new d("WASM_NOT_INITIALIZED","Not initialized");let o=Date.now(),n=e instanceof Uint8Array?e:new Uint8Array(e);if(n.length===0)throw new d("INVALID_INPUT","Empty document");let s=this.getExt(r)||t.inputFormat||"docx",i=t.outputFormat;if(!y[i])throw new d("UNSUPPORTED_FORMAT",`Unsupported: ${i}`);let a="";if(i==="pdf"&&t.pdf){let p=[];if(t.pdf.pdfaLevel){let g={"PDF/A-1b":1,"PDF/A-2b":2,"PDF/A-3b":3};p.push(`SelectPdfVersion=${g[t.pdf.pdfaLevel]||0}`);}t.pdf.quality!==void 0&&p.push(`Quality=${t.pdf.quality}`),a=p.join(",");}let l=await this.sendMessage("convert",{inputData:n,inputExt:s,outputFormat:i,filterOptions:a,password:t.password}),u=r.includes(".")?r.substring(0,r.lastIndexOf(".")):r,m=l.length>=2&&l[0]===80&&l[1]===75,h=["png","jpg","jpeg","svg"].includes(i.toLowerCase());return m&&h?{data:l,mimeType:"application/zip",filename:`${u}_pages.zip`,duration:Date.now()-o}:{data:l,mimeType:T[i],filename:`${u}.${i}`,duration:Date.now()-o}}async convertFile(e,t){let r=await e.arrayBuffer();return this.convert(new Uint8Array(r),t,e.name)}async convertFromUrl(e,t){let r=await fetch(e);if(!r.ok)throw new Error(`Fetch failed: ${r.statusText}`);let o=await r.arrayBuffer(),n=e.split("/").pop()||"document";return this.convert(new Uint8Array(o),t,n)}download(e,t){let r=new Uint8Array(e.data).buffer,o=new Blob([r],{type:e.mimeType}),n=URL.createObjectURL(o),s=document.createElement("a");s.href=n,s.download=t||e.filename,s.click(),setTimeout(()=>URL.revokeObjectURL(n),1e3);}createBlobUrl(e){let t=new Uint8Array(e.data).buffer,r=new Blob([t],{type:e.mimeType});return URL.createObjectURL(r)}preview(e){return window.open(this.createBlobUrl(e),"_blank")}async getPageCount(e,t){if(!this.initialized||!this.worker)throw new d("WASM_NOT_INITIALIZED","Not initialized");let r=e instanceof Uint8Array?e:new Uint8Array(e),o=t.inputFormat||"docx";return await this.sendMessage("getPageCount",{inputData:r,inputExt:o})}async renderPreviews(e,t,r=256){if(!this.initialized||!this.worker)throw new d("WASM_NOT_INITIALIZED","Not initialized");let o=e instanceof Uint8Array?e:new Uint8Array(e),n=t.inputFormat||"docx";return await this.sendMessage("renderPreviews",{inputData:o,inputExt:n,maxWidth:r})}async renderSinglePage(e,t,r,o=256){if(!this.initialized||!this.worker)throw new d("WASM_NOT_INITIALIZED","Not initialized");let n=e instanceof Uint8Array?e:new Uint8Array(e),s=t.inputFormat||"docx";return await this.sendMessage("renderSinglePage",{inputData:n,inputExt:s,pageIndex:r,maxWidth:o})}async renderPageViaConvert(e,t,r,o=256){if(!this.initialized||!this.worker)throw new d("WASM_NOT_INITIALIZED","Not initialized");let n=e instanceof Uint8Array?e:new Uint8Array(e),s=t.inputFormat||"pdf";return await this.sendMessage("renderPageViaConvert",{inputData:n,inputExt:s,pageIndex:r,maxWidth:o})}async getDocumentInfo(e,t){if(!this.initialized||!this.worker)throw new d("WASM_NOT_INITIALIZED","Not initialized");let r=e instanceof Uint8Array?e:new Uint8Array(e),o=t.inputFormat||"docx";return await this.sendMessage("getDocumentInfo",{inputData:r,inputExt:o})}async getLokInfo(e,t){if(!this.initialized||!this.worker)throw new d("WASM_NOT_INITIALIZED","Not initialized");let r=e instanceof Uint8Array?e:new Uint8Array(e),o=t.inputFormat||"docx";return await this.sendMessage("getLokInfo",{inputData:r,inputExt:o})}async renderPageRectangles(e,t,r=256){if(!this.initialized||!this.worker)throw new d("WASM_NOT_INITIALIZED","Not initialized");let o=e instanceof Uint8Array?e:new Uint8Array(e),n=t.inputFormat||"docx";return await this.sendMessage("renderPageRectangles",{inputData:o,inputExt:n,maxWidth:r})}async editText(e,t,r){if(!this.initialized||!this.worker)throw new d("WASM_NOT_INITIALIZED","Not initialized");let o=e instanceof Uint8Array?e:new Uint8Array(e),n=t.inputFormat||"docx";return await this.sendMessage("editText",{inputData:o,inputExt:n,findText:r.findText,replaceText:r.replaceText,insertText:r.insertText})}async testLokOperations(e,t){if(!this.initialized||!this.worker)throw new d("WASM_NOT_INITIALIZED","Not initialized");let r=e instanceof Uint8Array?e:new Uint8Array(e),o=t.inputFormat||"docx";return await this.sendMessage("testLokOperations",{inputData:r,inputExt:o})}async openDocument(e,t){if(!this.initialized||!this.worker)throw new d("WASM_NOT_INITIALIZED","Not initialized");let r=e instanceof Uint8Array?e:new Uint8Array(e),o=t.inputFormat||"docx",n=await this.sendMessage("openDocument",{inputData:r,inputExt:o});return new D(this,n.sessionId,n.documentType,n.pageCount)}async _sendEditorOperation(e,t,r=[]){return await this.sendMessage("editorOperation",{sessionId:e,editorMethod:t,editorArgs:r})}async _closeDocument(e){return await this.sendMessage("closeDocument",{sessionId:e})}async renderPage(e,t,r,o,n){return this.renderSinglePage(e,t,r,o)}async renderPagePreviews(e,t,r){let o=r?.width??256;return this.renderPreviews(e,t,o)}async renderPageFullQuality(e,t,r,o){if(!this.initialized||!this.worker)throw new d("WASM_NOT_INITIALIZED","Not initialized");let n=e instanceof Uint8Array?e:new Uint8Array(e),s=t.inputFormat||"docx";return await this.sendMessage("renderPageFullQuality",{inputData:n,inputExt:s,pageIndex:r,dpi:o?.dpi??150,maxDimension:o?.maxDimension,editMode:o?.editMode??false})}async editorOperation(e,t,r){return await this._sendEditorOperation(e,t,r??[])}async closeDocument(e){return this._closeDocument(e)}async destroy(){if(this.worker){try{await this.sendMessage("destroy");}catch{}this.worker.terminate(),this.worker=null;}this.initialized=false,this.pendingRequests.clear();}isReady(){return this.initialized&&this.worker!==null}static getSupportedOutputFormats(){return Object.keys(y)}getExt(e){let t=e.split(".");return t.length>1&&t.pop()?.toLowerCase()||null}emitProgress(e,t,r){this.options.onProgress?.({phase:e,percent:t,message:r});}},D=class{converter;_sessionId;_documentType;_pageCount;_closed=false;constructor(e,t,r,o){this.converter=e,this._sessionId=t,this._documentType=r,this._pageCount=o;}get sessionId(){return this._sessionId}get documentType(){return this._documentType}get pageCount(){return this._pageCount}get isOpen(){return !this._closed}async getStructure(){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"getStructure")}async undo(){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"undo")}async redo(){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"redo")}async find(e,t){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"find",[e,t])}async findAndReplaceAll(e,t,r){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"findAndReplaceAll",[e,t,r])}async getSelection(){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"getSelection")}async clearSelection(){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"clearSelection")}async getStateChanges(){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"getStateChanges")}async flushAndPollState(){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"flushAndPollState")}async getFormat(){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"getFormat")}async getSelectionFormat(){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"getSelectionFormat")}async getParagraph(e){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"getParagraph",[e])}async getParagraphs(e,t){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"getParagraphs",[e,t])}async insertParagraph(e,t){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"insertParagraph",[e,t])}async replaceParagraph(e,t){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"replaceParagraph",[e,t])}async deleteParagraph(e){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"deleteParagraph",[e])}async formatText(e,t){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"formatText",[e,t])}async replaceText(e,t,r){return this.assertOpen(),this.converter._sendEditorOperation(this._sessionId,"replaceText",[e,t,r])}async close(){return this.assertOpen(),this._closed=true,this.converter._closeDocument(this._sessionId)}assertOpen(){if(this._closed)throw new Error("Document session is closed")}};function ze(c,e){let t=typeof c=="string"?document.querySelector(c):c;if(!t)throw new Error("Element not found");let r=null,o=async i=>{i.preventDefault(),t.classList.remove("dragover");let a=i.dataTransfer?.files;if(!a?.length)return Promise.resolve();try{r||(r=new I({sofficeJs:e.sofficeJs,sofficeWasm:e.sofficeWasm,sofficeData:e.sofficeData,sofficeWorkerJs:e.sofficeWorkerJs,onProgress:e.onProgress?l=>e.onProgress({percent:l.percent,message:l.message}):void 0}),await r.initialize());for(let l of Array.from(a)){let u=await r.convertFile(l,{outputFormat:e.outputFormat});e.onConvert?.(u),e.autoDownload!==!1&&r.download(u);}}catch(l){e.onError?.(l);}},n=i=>{i.preventDefault(),t.classList.add("dragover");},s=i=>{i.preventDefault(),t.classList.remove("dragover");};return t.addEventListener("drop",o),t.addEventListener("dragover",n),t.addEventListener("dragleave",s),{destroy:()=>{t.removeEventListener("drop",o),t.removeEventListener("dragover",n),t.removeEventListener("dragleave",s),r?.destroy();}}}async function Ge(c,e,t){let r=new I({sofficeJs:t.sofficeJs,sofficeWasm:t.sofficeWasm,sofficeData:t.sofficeData,sofficeWorkerJs:t.sofficeWorkerJs});try{await r.initialize();let o=await r.convertFile(c,{outputFormat:e});return t.download!==!1&&r.download(o),o}finally{await r.destroy();}}
export{I as BrowserConverter,D as BrowserEditorProxy,O as CalcEditor,d as ConversionError,L as ConversionErrorCode,F as DEFAULT_WASM_BASE_URL,R as DrawEditor,B as EXTENSION_TO_FORMAT,y as FORMAT_FILTERS,T as FORMAT_MIME_TYPES,v as ImpressEditor,_ as OfficeEditor,W as WorkerBrowserConverter,C as WriterEditor,ze as createDropZone,x as createEditor,w as createWasmPaths,J as isCalcEditor,Y as isDrawEditor,j as isImpressEditor,H as isWriterEditor,Ge as quickConvert};//# sourceMappingURL=browser.js.map
//# sourceMappingURL=browser.js.map